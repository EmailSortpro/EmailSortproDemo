<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - EmailSortPro</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuration Supabase sécurisée via Netlify Functions -->
    <script>
        // Configuration Supabase sécurisée
        class SupabaseConfig {
            constructor() {
                this.config = null;
                this.initialized = false;
                console.log('[SupabaseConfig] Initializing with Netlify Functions...');
                this.loadConfig();
            }

            async loadConfig() {
                try {
                    // Charger la configuration depuis les variables d'environnement Netlify
                    // Créer une fonction Netlify pour exposer les variables de manière sécurisée
                    const response = await fetch('/.netlify/functions/get-supabase-config');
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch config: ${response.status}`);
                    }
                    
                    const configData = await response.json();
                    
                    this.config = {
                        url: configData.url,
                        anonKey: configData.anonKey,
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: false,
                            storage: window.localStorage
                        }
                    };
                    
                    this.initialized = true;
                    console.log('[SupabaseConfig] Configuration loaded securely from Netlify');
                    
                } catch (error) {
                    console.error('[SupabaseConfig] Failed to load configuration:', error);
                    
                    // Fallback pour le développement local - utilisez un fichier .env local
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        console.warn('[SupabaseConfig] Using fallback configuration for local development');
                        this.config = {
                            url: process.env.VITE_SUPABASE_URL || 'YOUR_LOCAL_SUPABASE_URL',
                            anonKey: process.env.VITE_SUPABASE_ANON_KEY || 'YOUR_LOCAL_SUPABASE_ANON_KEY',
                            auth: {
                                autoRefreshToken: true,
                                persistSession: true,
                                detectSessionInUrl: false,
                                storage: window.localStorage
                            }
                        };
                        this.initialized = true;
                    } else {
                        throw error;
                    }
                }
            }

            getConfig() {
                return this.config;
            }

            validate() {
                const issues = [];
                if (!this.config.url) issues.push('URL manquante');
                if (!this.config.anonKey) issues.push('Clé manquante');
                return { valid: issues.length === 0, issues };
            }

            async testConnection() {
                try {
                    const client = window.supabase.createClient(this.config.url, this.config.anonKey, this.config.auth);
                    const { data, error } = await client.auth.getSession();
                    return { success: !error || !error.message.includes('Invalid API key'), message: 'Connexion réussie' };
                } catch (error) {
                    return { success: false, message: error.message, error };
                }
            }
        }
        
        // Initialiser de manière asynchrone
        window.supabaseConfigPromise = (async () => {
            const config = new SupabaseConfig();
            await config.loadConfig();
            return config;
        })();
    </script>
    
    <!-- Service de Licence sécurisé -->
    <script>
        // LicenseService avec configuration sécurisée
        class LicenseService {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.licenseCache = null;
                this.initialized = false;
            }

            async initialize() {
                if (this.initialized) return true;
                try {
                    // Attendre que la configuration soit chargée
                    const supabaseConfig = await window.supabaseConfigPromise;
                    const config = supabaseConfig.getConfig();
                    
                    if (!config.url || !config.anonKey) {
                        throw new Error('Configuration Supabase manquante');
                    }
                    
                    this.supabase = window.supabase.createClient(config.url, config.anonKey, config.auth);
                    this.initialized = true;
                    console.log('[LicenseService] ✅ Initialisé avec configuration sécurisée');
                    return true;
                } catch (error) {
                    console.error('[LicenseService] ❌ Erreur initialisation:', error);
                    return false;
                }
            }

            async authenticateWithEmail(email) {
                if (!this.initialized) {
                    const success = await this.initialize();
                    if (!success) {
                        return { valid: false, error: 'Service non initialisé' };
                    }
                }
                
                if (!this.supabase) return { valid: false, error: 'Service non initialisé' };

                try {
                    const cleanEmail = email.toLowerCase().trim();
                    
                    // Rechercher l'utilisateur
                    let { data: user, error } = await this.supabase
                        .from('users')
                        .select('*, company:companies(*)')
                        .eq('email', cleanEmail)
                        .single();

                    if (error && error.code === 'PGRST116') {
                        // Créer l'utilisateur s'il n'existe pas
                        user = await this.createNewUser(cleanEmail);
                    } else if (error) {
                        throw error;
                    }

                    // Mettre à jour la dernière connexion
                    await this.updateLastLogin(user.id);

                    this.currentUser = user;
                    
                    const licenseStatus = this.evaluateLicenseStatus(user);
                    
                    return {
                        valid: licenseStatus.valid,
                        status: licenseStatus.status,
                        user: user,
                        message: licenseStatus.message,
                        daysRemaining: licenseStatus.daysRemaining
                    };
                } catch (error) {
                    console.error('[LicenseService] Erreur authentification:', error);
                    return { valid: false, error: error.message, status: 'error' };
                }
            }

            async createNewUser(email) {
                const domain = email.split('@')[1];
                const name = email.split('@')[0];
                
                const { data: company } = await this.supabase
                    .from('companies')
                    .select('*')
                    .eq('domain', domain)
                    .single();

                const isPersonalEmail = ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'live.com'].includes(domain.toLowerCase());
                
                let companyId = company?.id;
                if (isPersonalEmail && !company) {
                    const { data: newCompany } = await this.supabase
                        .from('companies')
                        .insert([{
                            name: `Personnel - ${email}`,
                            domain: email,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    companyId = newCompany?.id;
                }

                // Calculer la date d'expiration (15 jours d'essai)
                const trialDays = 15;
                const expirationDate = new Date();
                expirationDate.setDate(expirationDate.getDate() + trialDays);

                // Si c'est vianney.hastings@hotmail.fr, le créer comme company_admin
                const isVianney = email.toLowerCase() === 'vianney.hastings@hotmail.fr';
                
                const newUser = {
                    email: email.toLowerCase(),
                    name: name,
                    company_id: companyId,
                    role: isVianney ? 'company_admin' : (isPersonalEmail ? 'admin' : 'user'),
                    license_status: 'trial',
                    license_expires_at: expirationDate.toISOString(),
                    first_login_at: new Date().toISOString(),
                    created_at: new Date().toISOString()
                };

                const { data, error } = await this.supabase
                    .from('users')
                    .insert([newUser])
                    .select('*, company:companies(*)')
                    .single();

                if (error) throw error;
                return data;
            }

            evaluateLicenseStatus(user) {
                // Pour la page analytics, on vérifie seulement si l'utilisateur est admin
                // On ne bloque PAS l'accès pour les licences expirées
                if (user.license_status === 'blocked') {
                    return { valid: false, status: 'blocked', message: 'Accès bloqué' };
                }

                // Vérifier si l'utilisateur est admin
                const isAdmin = user.role === 'admin' || user.role === 'company_admin' || user.role === 'super_admin';
                
                if (!isAdmin) {
                    return { 
                        valid: false, 
                        status: 'unauthorized', 
                        message: 'Accès réservé aux administrateurs' 
                    };
                }

                // Pour les admins, on autorise l'accès même avec une licence expirée
                const expiresAt = user.license_expires_at ? new Date(user.license_expires_at) : null;
                const now = new Date();
                let licenseInfo = '';
                let daysRemaining = null;

                if (expiresAt && expiresAt < now) {
                    licenseInfo = 'Licence expirée - Accès analytics autorisé';
                } else if (expiresAt) {
                    daysRemaining = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                    licenseInfo = `Licence ${user.license_status} - ${daysRemaining} jours restants`;
                } else {
                    licenseInfo = `Licence ${user.license_status}`;
                }

                // Les admins ont toujours accès aux analytics
                return {
                    valid: true,
                    status: user.license_status,
                    message: licenseInfo,
                    daysRemaining,
                    isAdmin: true
                };
            }

            async updateLastLogin(userId) {
                try {
                    await this.supabase
                        .from('users')
                        .update({ last_login_at: new Date().toISOString() })
                        .eq('id', userId);
                } catch (error) {
                    console.warn('[LicenseService] Erreur mise à jour login:', error);
                }
            }

            getCurrentUser() {
                return this.currentUser;
            }

            isAdmin() {
                // Vérifier tous les rôles admin possibles
                return this.currentUser?.role === 'admin' || 
                       this.currentUser?.role === 'company_admin' || 
                       this.currentUser?.role === 'super_admin';
            }

            async getCompanyUsers() {
                if (!this.currentUser?.company_id || !this.isAdmin()) return [];
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .select('*')
                        .eq('company_id', this.currentUser.company_id)
                        .order('created_at', { ascending: false });
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('[LicenseService] Erreur récupération utilisateurs:', error);
                    return [];
                }
            }

            async getUserAnalytics(userId = null) {
                try {
                    const targetUserId = userId || this.currentUser?.id;
                    if (!targetUserId) return [];
                    const { data, error } = await this.supabase
                        .from('analytics_events')
                        .select('*')
                        .eq('user_id', targetUserId)
                        .order('created_at', { ascending: false })
                        .limit(100);
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('[LicenseService] Erreur récupération analytics:', error);
                    return [];
                }
            }

            async updateUserLicense(userId, status, expiresAt = null) {
                if (!this.isAdmin()) throw new Error('Droits insuffisants');
                try {
                    const updateData = { license_status: status, updated_at: new Date().toISOString() };
                    if (expiresAt) updateData.license_expires_at = expiresAt;
                    
                    const { error } = await this.supabase
                        .from('users')
                        .update(updateData)
                        .eq('id', userId)
                        .eq('company_id', this.currentUser.company_id);
                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async addUserToCompany(email) {
                if (!this.isAdmin()) throw new Error('Droits insuffisants');
                try {
                    const { data: existingUser } = await this.supabase
                        .from('users')
                        .select('*')
                        .eq('email', email.toLowerCase())
                        .single();

                    if (existingUser?.company_id) {
                        throw new Error('Utilisateur déjà dans une société');
                    }

                    if (existingUser) {
                        const { error } = await this.supabase
                            .from('users')
                            .update({
                                company_id: this.currentUser.company_id,
                                license_status: 'active',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existingUser.id);
                        if (error) throw error;
                    } else {
                        const { error } = await this.supabase
                            .from('users')
                            .insert([{
                                email: email.toLowerCase(),
                                name: email.split('@')[0],
                                company_id: this.currentUser.company_id,
                                role: 'user',
                                license_status: 'active',
                                created_at: new Date().toISOString()
                            }]);
                        if (error) throw error;
                    }
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            // Nouvelles méthodes pour la gestion des paiements
            async getCompanyPaymentInfo() {
                if (!this.currentUser?.company_id) return null;
                try {
                    const { data, error } = await this.supabase
                        .from('companies')
                        .select('*, payment_info:company_payments(*)')
                        .eq('id', this.currentUser.company_id)
                        .single();
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('[LicenseService] Erreur récupération info paiement:', error);
                    return null;
                }
            }

            async getPaymentHistory() {
                if (!this.currentUser?.company_id) return [];
                try {
                    const { data, error } = await this.supabase
                        .from('payment_history')
                        .select('*')
                        .eq('company_id', this.currentUser.company_id)
                        .order('created_at', { ascending: false });
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('[LicenseService] Erreur récupération historique paiements:', error);
                    return [];
                }
            }

            async createPaymentIntent(licenseCount) {
                if (!this.currentUser?.company_id) throw new Error('Aucune société associée');
                try {
                    // Simuler la création d'un payment intent (sera remplacé par l'API Stripe)
                    const amount = licenseCount * 990; // 9.90€ en centimes
                    return {
                        intentId: `pi_${Date.now()}`,
                        amount: amount,
                        currency: 'eur',
                        status: 'requires_payment_method'
                    };
                } catch (error) {
                    console.error('[LicenseService] Erreur création payment intent:', error);
                    throw error;
                }
            }

            async syncLocalAnalytics() {
                // Méthode vide pour compatibilité
                console.log('[LicenseService] Sync analytics called');
            }
        }
        
        // Initialiser le service de manière asynchrone
        window.licenseServicePromise = (async () => {
            const service = new LicenseService();
            await service.initialize();
            return service;
        })();
        
        console.log('✅ LicenseService configuré avec sécurité renforcée');
    </script>
    
    <!-- Styles CSS restent identiques -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            line-height: 1.6;
        }

        .analytics-standalone {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 48px;
            padding: 40px 0;
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            color: white;
            border-radius: 16px;
            margin: 0 0 48px 0;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .page-header p {
            font-size: 1.25rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
        }

        .auth-box {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 90%;
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .auth-submit {
            padding: 14px 28px;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-submit:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .auth-submit:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
        }

        .auth-info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
        }

        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-size: 1.125rem;
            font-weight: 500;
        }

        /* Ajoutez ici tous les autres styles CSS de votre fichier original */
    </style>
</head>
<body>
    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2 class="auth-title">
                <i class="fas fa-chart-line"></i>
                Analytics EmailSortPro
            </h2>
            <form id="authForm" class="auth-form">
                <div class="auth-info">
                    <i class="fas fa-info-circle"></i>
                    Accès réservé aux administrateurs
                    <br>
                    <small>Configuration sécurisée via Netlify Functions</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="emailInput">Adresse Email</label>
                    <input 
                        type="email" 
                        id="emailInput" 
                        class="form-input" 
                        placeholder="vianney.hastings@hotmail.fr"
                        value="vianney.hastings@hotmail.fr"
                        required
                    >
                </div>
                <button type="submit" id="authSubmit" class="auth-submit">
                    <i class="fas fa-sign-in-alt"></i>
                    Accéder aux Analytics
                </button>
                <div id="authError" class="auth-error" style="display: none;"></div>
            </form>
        </div>
    </div>

    <div id="mainContent" class="analytics-standalone" style="display: none;">
        <div id="loadingContainer" class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">Chargement de la configuration sécurisée...</div>
        </div>
        <!-- Le reste du contenu sera chargé dynamiquement -->
    </div>

    <script>
        // Variables globales
        let licenseService = null;
        let currentUser = null;

        // Fonction principale d'initialisation
        async function initializeApp() {
            try {
                console.log('[Analytics] Initialisation avec configuration sécurisée...');
                
                // Attendre que le service de licence soit prêt
                licenseService = await window.licenseServicePromise;
                
                console.log('[Analytics] Service de licence initialisé');
                
                // Vérifier l'authentification
                await checkAuthentication();
                
            } catch (error) {
                console.error('[Analytics] Erreur d\'initialisation:', error);
                showError('Erreur de configuration: ' + error.message);
            }
        }

        function showError(message) {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        async function checkAuthentication() {
            console.log('[Analytics] Vérification de l\'authentification...');
            
            // Vérifier si on a déjà un utilisateur en session
            const storedEmail = localStorage.getItem('emailsortpro_user_email');
            
            if (storedEmail) {
                // Essayer de se connecter automatiquement
                const result = await authenticateUser(storedEmail);
                if (result.success) {
                    showMainContent(result.user);
                    return;
                }
            }
            
            // Sinon, afficher le formulaire de connexion
            showAuthForm();
        }

        function showAuthForm() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function showMainContent(user) {
            currentUser = user;
            console.log('[Analytics] Utilisateur connecté:', user.email);
            
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Ici vous pouvez charger le reste de votre interface analytics
            loadAnalyticsInterface();
        }

        async function authenticateUser(email) {
            try {
                if (!licenseService) {
                    throw new Error('Service de licence non disponible');
                }
                
                const result = await licenseService.authenticateWithEmail(email);
                
                if (result.valid) {
                    localStorage.setItem('emailsortpro_user_email', email);
                    return { success: true, user: result.user };
                } else {
                    return { success: false, error: result.message || 'Authentification échouée' };
                }
            } catch (error) {
                console.error('[Analytics] Erreur d\'authentification:', error);
                return { success: false, error: error.message };
            }
        }

        function loadAnalyticsInterface() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="page-header">
                    <h1>
                        <i class="fas fa-chart-line"></i>
                        Analytics EmailSortPro
                    </h1>
                    <p>Configuration sécurisée via Netlify Functions</p>
                </div>
                
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-check-circle" style="font-size: 4rem; color: #10b981; margin-bottom: 20px;"></i>
                    <h2>Configuration sécurisée activée</h2>
                    <p>Utilisateur connecté: <strong>${currentUser.email}</strong></p>
                    <p>Rôle: <strong>${currentUser.role}</strong></p>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px;">
                        <h3>✅ Sécurité renforcée</h3>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>Clés API sécurisées via Netlify Functions</li>
                            <li>Variables d'environnement cachées</li>
                            <li>Configuration chargée dynamiquement</li>
                            <li>Authentification sécurisée</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Event listener pour le formulaire d'authentification
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('emailInput').value.trim();
            const submitBtn = document.getElementById('authSubmit');
            const errorDiv = document.getElementById('authError');
            
            if (!email) {
                errorDiv.textContent = 'Veuillez entrer une adresse email';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Désactiver le bouton pendant l'authentification
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connexion...';
            errorDiv.style.display = 'none';
            
            const result = await authenticateUser(email);
            
            if (result.success) {
                showMainContent(result.user);
            } else {
                errorDiv.textContent = result.error || 'Erreur d\'authentification';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Accéder aux Analytics';
            }
        });

        // Initialiser l'application au chargement de la page
        window.addEventListener('load', initializeApp);

        console.log('[Analytics] Page initialisée avec configuration sécurisée');
    </script>
</body>
</html>
