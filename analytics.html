// Gestion des analytics et des donn√©es
class AnalyticsManager {
    constructor() {
        this.companies = [];
        this.users = [];
        this.licenses = [];
        this.analyticsEvents = [];
        this.testMode = true; // Mode test activ√©
    }

    // Charger toutes les donn√©es (selon le r√¥le)
    async loadData() {
        // En mode test, charger des donn√©es fictives
        if (this.testMode || !window.supabaseClient) {
            console.log('[Analytics] üß™ Mode test - Chargement de donn√©es fictives');
            this.loadTestData();
            return;
        }
        
        const userRole = authManager.getUserRole();
        
        try {
            if (userRole === USER_ROLES.SUPER_ADMIN) {
                // Super admin : acc√®s √† toutes les donn√©es
                await this.loadAllCompanies();
                await this.loadAllUsers();
                await this.loadAllLicenses();
                await this.loadAllAnalytics();
            } else if (userRole === USER_ROLES.ADMIN) {
                // Admin : acc√®s aux donn√©es de sa soci√©t√© uniquement
                const companyId = authManager.currentUser.company_id;
                await this.loadCompanyData(companyId);
            } else {
                // Utilisateur normal : acc√®s √† ses propres donn√©es uniquement
                await this.loadUserData(authManager.currentUser.id);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des donn√©es:', error);
            // En cas d'erreur, charger les donn√©es de test
            this.loadTestData();
        }
    }

    // Charger des donn√©es de test
    loadTestData() {
        // Soci√©t√©s fictives
        this.companies = [
            { id: '1', name: 'Entreprise Alpha', domain: 'alpha.com', created_at: '2024-01-15' },
            { id: '2', name: 'Soci√©t√© Beta', domain: 'beta.fr', created_at: '2024-02-20' },
            { id: '3', name: 'Groupe Gamma', domain: 'gamma.io', created_at: '2024-03-10' }
        ];

        // Utilisateurs fictifs
        this.users = [
            { 
                id: '1', 
                email: 'admin@alpha.com', 
                name: 'Jean Admin', 
                company_id: '1',
                companies: { name: 'Entreprise Alpha' },
                role: 'admin',
                license_status: 'active',
                license_expires_at: '2025-12-31',
                last_login_at: new Date().toISOString()
            },
            { 
                id: '2', 
                email: 'user@beta.fr', 
                name: 'Marie User', 
                company_id: '2',
                companies: { name: 'Soci√©t√© Beta' },
                role: 'user',
                license_status: 'trial',
                license_expires_at: '2025-07-15',
                last_login_at: '2025-06-25'
            },
            { 
                id: '3', 
                email: 'test@gamma.io', 
                name: 'Pierre Test', 
                company_id: '3',
                companies: { name: 'Groupe Gamma' },
                role: 'user',
                license_status: 'expired',
                license_expires_at: '2025-05-01',
                last_login_at: '2025-06-20'
            }
        ];

        // Licences fictives
        this.licenses = [
            {
                id: '1',
                company_id: '1',
                companies: { name: 'Entreprise Alpha' },
                type: 'premium',
                seats: 50,
                used_seats: 32,
                price: 4999.99,
                status: 'active',
                expires_at: '2025-12-31'
            },
            {
                id: '2',
                company_id: '2',
                companies: { name: 'Soci√©t√© Beta' },
                type: 'standard',
                seats: 20,
                used_seats: 15,
                price: 1999.99,
                status: 'active',
                expires_at: '2025-07-15'
            }
        ];

        // √âv√©nements analytics fictifs
        const eventTypes = ['page_view', 'feature_use', 'export_data', 'user_login', 'report_generated'];
        const now = new Date();
        
        this.analyticsEvents = [];
        for (let i = 0; i < 100; i++) {
            const daysAgo = Math.floor(Math.random() * 30);
            const eventDate = new Date(now);
            eventDate.setDate(eventDate.getDate() - daysAgo);
            
            this.analyticsEvents.push({
                id: `event-${i}`,
                user_id: this.users[Math.floor(Math.random() * this.users.length)].id,
                users: this.users[Math.floor(Math.random() * this.users.length)],
                event_type: eventTypes[Math.floor(Math.random() * eventTypes.length)],
                event_data: { test: true, value: Math.random() * 100 },
                created_at: eventDate.toISOString()
            });
        }

        // Trier par date d√©croissante
        this.analyticsEvents.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    }

    // Charger toutes les soci√©t√©s
    async loadAllCompanies() {
        const { data, error } = await supabaseClient
            .from('companies')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;
        this.companies = data;
    }

    // Charger tous les utilisateurs
    async loadAllUsers() {
        const { data, error } = await supabaseClient
            .from('users')
            .select(`
                *,
                companies (name)
            `)
            .order('created_at', { ascending: false });

        if (error) throw error;
        this.users = data;
    }

    // Charger toutes les licences
    async loadAllLicenses() {
        const { data, error } = await supabaseClient
            .from('licenses')
            .select(`
                *,
                companies (name),
                users (email, name)
            `)
            .order('created_at', { ascending: false });

        if (error) throw error;
        this.licenses = data;
    }

    // Charger tous les √©v√©nements analytics
    async loadAllAnalytics() {
        const { data, error } = await supabaseClient
            .from('analytics_events')
            .select(`
                *,
                users (email, name)
            `)
            .order('created_at', { ascending: false })
            .limit(1000);

        if (error) throw error;
        this.analyticsEvents = data;
    }

    // Charger les donn√©es d'une soci√©t√© sp√©cifique
    async loadCompanyData(companyId) {
        // Utilisateurs de la soci√©t√©
        const { data: users, error: usersError } = await supabaseClient
            .from('users')
            .select('*')
            .eq('company_id', companyId)
            .order('created_at', { ascending: false });

        if (usersError) throw usersError;
        this.users = users;

        // Licences de la soci√©t√©
        const { data: licenses, error: licensesError } = await supabaseClient
            .from('licenses')
            .select('*')
            .eq('company_id', companyId)
            .order('created_at', { ascending: false });

        if (licensesError) throw licensesError;
        this.licenses = licenses;

        // √âv√©nements analytics des utilisateurs de la soci√©t√©
        const userIds = users.map(u => u.id);
        if (userIds.length > 0) {
            const { data: events, error: eventsError } = await supabaseClient
                .from('analytics_events')
                .select('*')
                .in('user_id', userIds)
                .order('created_at', { ascending: false })
                .limit(500);

            if (eventsError) throw eventsError;
            this.analyticsEvents = events;
        }
    }

    // Charger les donn√©es d'un utilisateur sp√©cifique
    async loadUserData(userId) {
        const { data: events, error } = await supabaseClient
            .from('analytics_events')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(100);

        if (error) throw error;
        this.analyticsEvents = events;
    }

    // Obtenir les statistiques globales
    getGlobalStats() {
        const now = new Date();
        
        return {
            totalCompanies: this.companies.length,
            totalUsers: this.users.length,
            activeUsers: this.users.filter(u => 
                u.license_status === LICENSE_STATUS.ACTIVE || 
                u.license_status === LICENSE_STATUS.TRIAL
            ).length,
            totalLicenses: this.licenses.length,
            activeLicenses: this.licenses.filter(l => 
                l.status === 'active' && 
                new Date(l.expires_at) > now
            ).length,
            totalEvents: this.analyticsEvents.length,
            eventsToday: this.analyticsEvents.filter(e => {
                const eventDate = new Date(e.created_at);
                return eventDate.toDateString() === now.toDateString();
            }).length
        };
    }

    // Obtenir les statistiques par soci√©t√©
    getCompanyStats(companyId) {
        const companyUsers = this.users.filter(u => u.company_id === companyId);
        const companyLicenses = this.licenses.filter(l => l.company_id === companyId);
        const userIds = companyUsers.map(u => u.id);
        const companyEvents = this.analyticsEvents.filter(e => userIds.includes(e.user_id));

        return {
            totalUsers: companyUsers.length,
            activeUsers: companyUsers.filter(u => 
                u.license_status === LICENSE_STATUS.ACTIVE || 
                u.license_status === LICENSE_STATUS.TRIAL
            ).length,
            licenses: companyLicenses,
            totalEvents: companyEvents.length
        };
    }

    // Enregistrer un √©v√©nement analytics
    async trackEvent(eventType, eventData = {}) {
        if (!authManager.currentUser) return;

        try {
            const { error } = await supabaseClient
                .from('analytics_events')
                .insert({
                    user_id: authManager.currentUser.id,
                    event_type: eventType,
                    event_data: eventData
                });

            if (error) throw error;
        } catch (error) {
            console.error('Erreur lors de l\'enregistrement de l\'√©v√©nement:', error);
        }
    }
}

// Ajouter la m√©thode loadData pour charger les vraies donn√©es depuis Supabase
if (!window.analyticsManager) {
    window.analyticsManager = new AnalyticsManager();
}

// Ajouter la fonction loadData qui charge depuis la BDD
window.analyticsManager.loadData = async function() {
    console.log('[Analytics] Chargement des donn√©es depuis la base de donn√©es...');
    
    try {
        // V√©rifier que Supabase est initialis√©
        if (!window.supabaseClient) {
            console.error('[Analytics] Supabase non initialis√©');
            // En mode test, charger des donn√©es fictives
            this.loadTestData();
            return;
        }

        // D√©terminer le r√¥le de l'utilisateur
        const userRole = window.authManager?.currentUser?.role || 'user';
        console.log('[Analytics] R√¥le utilisateur:', userRole);

        // Charger les donn√©es selon le r√¥le
        if (userRole === 'super_admin') {
            // Super admin : acc√®s √† tout
            await Promise.all([
                this.loadCompanies(),
                this.loadUsers(),
                this.loadLicenses(),
                this.loadAnalyticsEvents()
            ]);
        } else if (userRole === 'admin') {
            // Admin : donn√©es de sa soci√©t√©
            const companyId = window.authManager?.currentUser?.company_id;
            if (companyId) {
                await this.loadCompanyData(companyId);
            }
        } else {
            // Utilisateur : ses propres donn√©es
            const userId = window.authManager?.currentUser?.id;
            if (userId) {
                await this.loadUserEvents(userId);
            }
        }

        console.log('[Analytics] Donn√©es charg√©es avec succ√®s');
    } catch (error) {
        console.error('[Analytics] Erreur lors du chargement des donn√©es:', error);
        // En cas d'erreur, charger des donn√©es de test
        this.loadTestData();
    }
};

// Fonction pour charger toutes les soci√©t√©s
window.analyticsManager.loadCompanies = async function() {
    const { data, error } = await window.supabaseClient
        .from('companies')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('[Analytics] Erreur chargement soci√©t√©s:', error);
        return;
    }

    this.companies = data || [];
    console.log('[Analytics] Soci√©t√©s charg√©es:', this.companies.length);
};

// Fonction pour charger tous les utilisateurs
window.analyticsManager.loadUsers = async function() {
    const { data, error } = await window.supabaseClient
        .from('users')
        .select(`
            *,
            companies (name)
        `)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('[Analytics] Erreur chargement utilisateurs:', error);
        return;
    }

    this.users = data || [];
    console.log('[Analytics] Utilisateurs charg√©s:', this.users.length);
};

// Fonction pour charger toutes les licences
window.analyticsManager.loadLicenses = async function() {
    const { data, error } = await window.supabaseClient
        .from('licenses')
        .select(`
            *,
            companies (name),
            users (email, name)
        `)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('[Analytics] Erreur chargement licences:', error);
        return;
    }

    this.licenses = data || [];
    console.log('[Analytics] Licences charg√©es:', this.licenses.length);
};

// Fonction pour charger les √©v√©nements analytics
window.analyticsManager.loadAnalyticsEvents = async function() {
    const { data, error } = await window.supabaseClient
        .from('analytics_events')
        .select(`
            *,
            users (email, name)
        `)
        .order('created_at', { ascending: false })
        .limit(1000);

    if (error) {
        console.error('[Analytics] Erreur chargement √©v√©nements:', error);
        return;
    }

    this.events = data || [];
    console.log('[Analytics] √âv√©nements charg√©s:', this.events.length);
};

// Fonction pour charger les donn√©es d'une soci√©t√©
window.analyticsManager.loadCompanyData = async function(companyId) {
    // Utilisateurs de la soci√©t√©
    const { data: users, error: usersError } = await window.supabaseClient
        .from('users')
        .select('*')
        .eq('company_id', companyId)
        .order('created_at', { ascending: false });

    if (!usersError) {
        this.users = users || [];
    }

    // Licences de la soci√©t√©
    const { data: licenses, error: licensesError } = await window.supabaseClient
        .from('licenses')
        .select('*')
        .eq('company_id', companyId)
        .order('created_at', { ascending: false });

    if (!licensesError) {
        this.licenses = licenses || [];
    }

    // √âv√©nements des utilisateurs
    if (this.users.length > 0) {
        const userIds = this.users.map(u => u.id);
        const { data: events, error: eventsError } = await window.supabaseClient
            .from('analytics_events')
            .select('*')
            .in('user_id', userIds)
            .order('created_at', { ascending: false })
            .limit(500);

        if (!eventsError) {
            this.events = events || [];
        }
    }
};

// Fonction pour charger les √©v√©nements d'un utilisateur
window.analyticsManager.loadUserEvents = async function(userId) {
    const { data, error } = await window.supabaseClient
        .from('analytics_events')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(100);

    if (!error) {
        this.events = data || [];
    }
};

// Fonction pour charger des donn√©es de test (fallback)
window.analyticsManager.loadTestData = function() {
    console.log('[Analytics] Chargement de donn√©es de test');
    
    this.companies = [
        { id: '1', name: 'Entreprise Alpha', domain: 'alpha.com', created_at: '2024-01-15' },
        { id: '2', name: 'Soci√©t√© Beta', domain: 'beta.fr', created_at: '2024-02-20' },
        { id: '3', name: 'Groupe Gamma', domain: 'gamma.io', created_at: '2024-03-10' }
    ];

    this.users = [
        { 
            id: '1', 
            email: 'admin@alpha.com', 
            name: 'Jean Admin', 
            company_id: '1',
            companies: { name: 'Entreprise Alpha' },
            role: 'admin',
            license_status: 'active',
            license_expires_at: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString(),
            last_login_at: new Date().toISOString()
        },
        { 
            id: '2', 
            email: 'user@beta.fr', 
            name: 'Marie User', 
            company_id: '2',
            companies: { name: 'Soci√©t√© Beta' },
            role: 'user',
            license_status: 'trial',
            license_expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
            last_login_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
        }
    ];

    this.licenses = [
        {
            id: '1',
            company_id: '1',
            companies: { name: 'Entreprise Alpha' },
            type: 'premium',
            seats: 50,
            used_seats: 15,
            price: 4999.99,
            status: 'active',
            expires_at: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString()
        }
    ];

    this.events = [];
    const eventTypes = ['page_view', 'feature_use', 'export_data', 'user_login'];
    
    // G√©n√©rer des √©v√©nements fictifs
    for (let i = 0; i < 50; i++) {
        const daysAgo = Math.floor(Math.random() * 7);
        const eventDate = new Date();
        eventDate.setDate(eventDate.getDate() - daysAgo);
        
        this.events.push({
            id: `event-${i}`,
            user_id: this.users[Math.floor(Math.random() * this.users.length)].id,
            users: this.users[Math.floor(Math.random() * this.users.length)],
            event_type: eventTypes[Math.floor(Math.random() * eventTypes.length)],
            event_data: { page: 'test', value: Math.random() * 100 },
            created_at: eventDate.toISOString()
        });
    }
};

// Fonction pour obtenir les statistiques
window.analyticsManager.getStats = function() {
    const now = new Date();
    const today = now.toDateString();
    
    return {
        totalCompanies: this.companies?.length || 0,
        totalUsers: this.users?.length || 0,
        activeUsers: this.users?.filter(u => 
            u.license_status === 'active' || u.license_status === 'trial'
        ).length || 0,
        totalLicenses: this.licenses?.length || 0,
        activeLicenses: this.licenses?.filter(l => 
            l.status === 'active' && new Date(l.expires_at) > now
        ).length || 0,
        totalEvents: this.events?.length || 0,
        eventsToday: this.events?.filter(e => 
            new Date(e.created_at).toDateString() === today
        ).length || 0
    };
};

console.log('[Analytics] Fonctions de chargement BDD ajout√©es √† analyticsManager');
