<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Admin - EmailSortPro</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-form h1 {
            text-align: center;
            margin-bottom: 8px;
            color: #1f2937;
            font-size: 1.5rem;
        }

        .login-form p {
            text-align: center;
            color: #6b7280;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success-message {
            background: #f0fdf4;
            color: #16a34a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }

        .tab-button {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            background: #f9fafb;
            color: #4b5563;
        }

        .tab-button.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background: #f8fafc;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f7fafc;
        }

        .domain-badge {
            background: #e6fffa;
            color: #234e52;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .user-count {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .email-count {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .license-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .license-active {
            background: #dcfce7;
            color: #16a34a;
        }

        .license-trial {
            background: #fef3c7;
            color: #d97706;
        }

        .license-expired {
            background: #fef2f2;
            color: #dc2626;
        }

        .license-blocked {
            background: #f3f4f6;
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-success {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }

        .user-type-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .type-professional {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-personal {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            min-width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active {
            background: #dcfce7;
            color: #16a34a;
        }
        .status-inactive {
            background: #f3f4f6;
            color: #6b7280;
        }

        .frequency-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .frequency-high {
            background: #ef4444;
            color: white;
        }

        .frequency-medium {
            background: #f59e0b;
            color: white;
        }

        .frequency-low {
            background: #10b981;
            color: white;
        }

        .frequency-none {
            background: #6b7280;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .close {
            color: #6b7280;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #374151;
        }

        .payment-info {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .price-display {
            font-size: 2rem;
            font-weight: 700;
            color: #4f46e5;
            text-align: center;
            margin: 1rem 0;
        }

        .trial-info {
            background: #fef3c7;
            color: #92400e;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .expiry-warning {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .contact-admin {
            background: #eff6ff;
            color: #1e40af;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            text-align: center;
        }

        .payment-history {
            margin-top: 1.5rem;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .date-input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .inline-edit {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            max-width: 120px;
        }

        .edit-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .edit-actions button {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <h1>üìß Analytics Admin</h1>
            <p>EmailSortPro - Acc√®s administrateur</p>
            
            <div id="alertContainer"></div>
            
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required 
                           placeholder="votre-email@domaine.com"
                           value="">
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe (optionnel)</label>
                    <input type="password" class="form-input" id="loginPassword"
                           placeholder="Laissez vide pour connexion rapide">
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">
                    Se connecter
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    üìß EmailSortPro Analytics
                </div>
                <div class="user-info">
                    <div class="user-badge" id="userBadge">
                        Chargement...
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        D√©connexion
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container">
            <div id="appAlertContainer"></div>

            <!-- Tabs Navigation -->
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('overview')">
                    <i class="fas fa-chart-line"></i>
                    Vue d'ensemble
                </button>
                <button class="tab-button" onclick="switchTab('activity')">
                    <i class="fas fa-users"></i>
                    Activit√© & Scans
                </button>
                <button class="tab-button" onclick="switchTab('licenses')">
                    <i class="fas fa-key"></i>
                    Gestion Licences
                </button>
                <button class="tab-button" onclick="switchTab('payments')">
                    <i class="fas fa-credit-card"></i>
                    Facturation
                </button>
            </div>

            <!-- Tab Contents -->
            
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">Utilisateurs Actifs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalLicenses">-</div>
                        <div class="stat-label">Licences Actives</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDomains">-</div>
                        <div class="stat-label">Domaines</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEmails">-</div>
                        <div class="stat-label">Emails Analys√©s</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-globe"></i>
                        Aper√ßu des Soci√©t√©s
                    </h3>
                    
                    <div class="filters">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="search-input" placeholder="Rechercher une soci√©t√©..." 
                                   id="companySearch" onkeyup="filterCompanies()">
                        </div>
                        <select class="filter-select" id="statusFilter" onchange="filterCompanies()">
                            <option value="">Tous les statuts</option>
                            <option value="active">Actif</option>
                            <option value="trial">Essai</option>
                            <option value="expired">Expir√©</option>
                        </select>
                        <button class="btn-secondary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table id="companiesTable">
                            <thead>
                                <tr>
                                    <th>Soci√©t√©</th>
                                    <th>Domaine</th>
                                    <th>Utilisateurs</th>
                                    <th>Administrateur</th>
                                    <th>Statut</th>
                                    <th>Licences Actives</th>
                                    <th>Revenus Mensuels</th>
                                </tr>
                            </thead>
                            <tbody id="companiesTableBody">
                                <tr><td colspan="7" style="text-align: center;">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activity Tab -->
            <div id="activity" class="tab-content">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        Activit√© des Utilisateurs et Fr√©quence de Scan
                    </h3>
                    
                    <div class="filters">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="search-input" placeholder="Rechercher un utilisateur..." 
                                   id="activitySearch" onkeyup="filterActivity()">
                        </div>
                        <select class="filter-select" id="frequencyFilter" onchange="filterActivity()">
                            <option value="">Toutes les fr√©quences</option>
                            <option value="high">√âlev√©e (>100/jour)</option>
                            <option value="medium">Moyenne (10-100/jour)</option>
                            <option value="low">Faible (1-10/jour)</option>
                            <option value="none">Inactive</option>
                        </select>
                        <select class="filter-select" id="companyFilter" onchange="filterActivity()">
                            <option value="">Toutes les soci√©t√©s</option>
                        </select>
                    </div>
                    
                    <div class="table-container">
                        <table id="activityTable">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Soci√©t√©</th>
                                    <th>Emails Scann√©s</th>
                                    <th>Scans/Jour (Moy.)</th>
                                    <th>Fr√©quence</th>
                                    <th>Derni√®re Activit√©</th>
                                    <th>Sessions</th>
                                    <th>Statut Licence</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <tr><td colspan="8" style="text-align: center;">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Licenses Tab -->
            <div id="licenses" class="tab-content">
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-key"></i>
                        Gestion des Licences
                    </h3>
                    
                    <div class="filters">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="search-input" placeholder="Rechercher un utilisateur..." 
                                   id="licenseSearch" onkeyup="filterLicenses()">
                        </div>
                        <select class="filter-select" id="licenseCompanyFilter" onchange="filterLicenses()">
                            <option value="">Toutes les soci√©t√©s</option>
                        </select>
                        <select class="filter-select" id="licenseStatusFilter" onchange="filterLicenses()">
                            <option value="">Tous les statuts</option>
                            <option value="active">Actif</option>
                            <option value="trial">Essai</option>
                            <option value="expired">Expir√©</option>
                            <option value="blocked">Bloqu√©</option>
                        </select>
                        <select class="filter-select" id="expiryFilter" onchange="filterLicenses()">
                            <option value="">Toutes les √©ch√©ances</option>
                            <option value="expired">D√©j√† expir√©</option>
                            <option value="soon">Expire bient√¥t (7 jours)</option>
                            <option value="month">Expire ce mois</option>
                        </select>
                        <select class="filter-select" id="userTypeFilter" onchange="filterLicenses()">
                            <option value="">Tous les types</option>
                            <option value="professional">Professionnel</option>
                            <option value="personal">Particulier</option>
                        </select>
                        <select class="filter-select" id="sortFilter" onchange="sortLicenses()">
                            <option value="name">Trier par nom</option>
                            <option value="company">Trier par soci√©t√©</option>
                            <option value="expiry">Trier par expiration</option>
                            <option value="status">Trier par statut</option>
                        </select>
                    </div>
                    
                    <div class="table-container">
                        <table id="licensesTable">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Type</th>
                                    <th>Soci√©t√©</th>
                                    <th>Statut Licence</th>
                                    <th>Date D√©but</th>
                                    <th>Date Expiration</th>
                                    <th>Jours Restants</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="licensesTableBody">
                                <tr><td colspan="8" style="text-align: center;">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="monthlyRevenue">-</div>
                        <div class="stat-label">Revenus Mensuels (HT)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="yearlyRevenue">-</div>
                        <div class="stat-label">Revenus Annuels (HT)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="unpaidUsers">-</div>
                        <div class="stat-label">Utilisateurs Impay√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="trialUsers">-</div>
                        <div class="stat-label">Utilisateurs en Essai</div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-credit-card"></i>
                        Suivi des Paiements et Facturation
                    </h3>
                    
                    <div class="filters">
                        <div class="search-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="search-input" placeholder="Rechercher..." 
                                   id="paymentSearch" onkeyup="filterPayments()">
                        </div>
                        <select class="filter-select" id="paymentStatusFilter" onchange="filterPayments()">
                            <option value="">Tous les statuts</option>
                            <option value="trial">Essai gratuit</option>
                            <option value="paid">Pay√©</option>
                            <option value="unpaid">Impay√©</option>
                            <option value="overdue">En retard</option>
                        </select>
                        <button class="btn-success" onclick="exportPayments()">
                            <i class="fas fa-download"></i> Exporter
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table id="paymentsTable">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Soci√©t√©</th>
                                    <th>Statut Paiement</th>
                                    <th>Montant Mensuel</th>
                                    <th>Prochaine √âch√©ance</th>
                                    <th>Jours de Retard</th>
                                    <th>Admin Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr><td colspan="8" style="text-align: center;">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading" style="display: none;">
                <div class="spinner"></div>
                <div>Chargement des donn√©es...</div>
            </div>
        </div>
    </div>

    <!-- Modal for License Edit -->
    <div id="licenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modifier la Licence</h3>
                <span class="close" onclick="closeLicenseModal()">&times;</span>
            </div>
            <div id="licenseModalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal for Payment Management -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Gestion des Paiements</h3>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div id="paymentModalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal for User Payment Info -->
    <div id="userPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Information de Paiement</h3>
                <span class="close" onclick="closeUserPaymentModal()">&times;</span>
            </div>
            <div id="userPaymentModalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Configuration et variables globales
        let supabaseClient = null;
        let currentUser = null;
        let allUsers = [];
        let allDomains = [];
        let allEvents = [];
        let currentTab = 'overview';

        // Constants
        const MONTHLY_PRICE = 9.90; // ‚Ç¨9.90 HT par mois
        const TRIAL_DAYS = 15; // 15 jours d'essai gratuit
        
        // Domaines consid√©r√©s comme personnels
        const PERSONAL_DOMAINS = [
            'gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'live.com',
            'icloud.com', 'protonmail.com', 'aol.com', 'msn.com', 'free.fr',
            'orange.fr', 'wanadoo.fr', 'laposte.net', 'sfr.fr', 'bbox.fr'
        ];

        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Analytics] Initialisation...');
            
            try {
                await initializeSupabase();
                setupEventListeners();
                await checkExistingSession();
            } catch (error) {
                console.error('[Analytics] Erreur initialisation:', error);
                showAlert('Erreur de configuration. Veuillez r√©essayer plus tard.', 'error');
            }
        });

        async function initializeSupabase() {
            try {
                console.log('[Analytics] Chargement de la configuration depuis Netlify...');
                
                const response = await fetch('/.netlify/functions/get-supabase-config');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Analytics] Erreur fonction Netlify:', response.status, errorText);
                    throw new Error(`Erreur ${response.status}: ${errorText}`);
                }
                
                const config = await response.json();
                console.log('[Analytics] Configuration re√ßue');
                
                if (!config.url || !config.anonKey) {
                    throw new Error('Configuration incompl√®te re√ßue de Netlify');
                }
                
                const cleanUrl = config.url.trim();
                const cleanKey = config.anonKey.trim();
                
                supabaseClient = window.supabase.createClient(
                    cleanUrl,
                    cleanKey,
                    {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: false
                        }
                    }
                );
                
                console.log('[Analytics] Supabase initialis√© avec succ√®s');
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('[Analytics] Test connexion √©chou√©:', error);
                    throw new Error('Impossible de se connecter √† Supabase: ' + error.message);
                } else {
                    console.log('[Analytics] ‚úÖ Connexion Supabase OK');
                }
                
            } catch (error) {
                console.error('[Analytics] ‚ùå Erreur initialisation Supabase:', error);
                showAlert('Erreur de configuration: ' + error.message, 'error');
                throw error;
            }
        }

        function setupEventListeners() {
            document.getElementById('authForm').addEventListener('submit', handleLogin);
            
            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
        }

        async function checkExistingSession() {
            if (!supabaseClient) return;
            
            try {
                const storedEmail = localStorage.getItem('emailsortpro_admin_email');
                if (storedEmail) {
                    console.log('[Auth] Email stock√© trouv√©:', storedEmail);
                    
                    const { data: user } = await supabaseClient
                        .from('users')
                        .select('*, company:companies(*)')
                        .eq('email', storedEmail)
                        .single();
                    
                    if (user && (user.role === 'company_admin' || user.role === 'super_admin')) {
                        currentUser = user;
                        showApp();
                        await loadDashboardData();
                        return;
                    }
                }
            } catch (error) {
                console.error('[Auth] Erreur v√©rification session:', error);
            }
        }

        // === AUTHENTIFICATION ===
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email) {
                showAlert('Email requis', 'error');
                return;
            }
            
            if (!supabaseClient) {
                showAlert('Connexion √† la base de donn√©es impossible', 'error');
                return;
            }
            
            setLoading(true);
            
            try {
                console.log('[Auth] Tentative de connexion pour:', email);
                
                const { data: user, error } = await supabaseClient
                    .from('users')
                    .select('*, company:companies(*)')
                    .eq('email', email)
                    .single();
                
                if (error || !user) {
                    throw new Error('Utilisateur non trouv√©');
                }
                
                if (user.role !== 'company_admin' && user.role !== 'super_admin') {
                    throw new Error('Acc√®s r√©serv√© aux administrateurs');
                }
                
                currentUser = user;
                localStorage.setItem('emailsortpro_admin_email', email);
                
                await supabaseClient
                    .from('users')
                    .update({ last_login_at: new Date().toISOString() })
                    .eq('id', user.id);
                
                showApp();
                await loadDashboardData();
                
            } catch (error) {
                console.error('[Auth] Erreur connexion:', error);
                showAlert(error.message || 'Erreur de connexion', 'error');
            } finally {
                setLoading(false);
            }
        }

        // === INTERFACE ===
        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            const userBadge = document.getElementById('userBadge');
            const roleName = currentUser.role === 'super_admin' ? 'Super Admin' : 'Admin';
            userBadge.textContent = `${currentUser.name || currentUser.email} (${roleName})`;
        }

        function showAlert(message, type = 'error') {
            const container = document.getElementById('alertContainer') || 
                            document.getElementById('appAlertContainer');
            
            if (!container) return;
            
            const alertClass = type === 'error' ? 'error-message' : 'success-message';
            container.innerHTML = `<div class="${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function setLoading(loading) {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.disabled = loading;
                loginBtn.textContent = loading ? 'Connexion...' : 'Se connecter';
            }
        }

        async function logout() {
            currentUser = null;
            localStorage.removeItem('emailsortpro_admin_email');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // === GESTION DES ONGLETS ===
        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // D√©sactiver tous les boutons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Charger les donn√©es sp√©cifiques √† l'onglet si n√©cessaire
            switch(tabName) {
                case 'activity':
                    renderActivityTable();
                    break;
                case 'licenses':
                    renderLicensesTable();
                    break;
                case 'payments':
                    renderPaymentsTable();
                    break;
                default:
                    renderCompaniesTable();
            }
        }

        // === CHARGEMENT DES DONN√âES ===
        async function loadDashboardData() {
            document.getElementById('loadingState').style.display = 'block';
            
            try {
                if (!supabaseClient) {
                    throw new Error('Connexion √† la base de donn√©es requise');
                }
                
                // Charger les utilisateurs avec leurs licences
                let usersQuery = supabaseClient
                    .from('users')
                    .select(`
                        *,
                        company:companies(*)
                    `)
                    .order('last_login_at', { ascending: false, nullsFirst: false });

                // Si admin de soci√©t√©, filtrer par soci√©t√©
                if (currentUser.role === 'company_admin') {
                    usersQuery = usersQuery.eq('company_id', currentUser.company_id);
                }

                const { data: users, error: usersError } = await usersQuery;
                
                if (usersError) throw usersError;
                
                console.log(`[Data] ${users?.length || 0} utilisateurs trouv√©s`);
                
                // Charger les √©v√©nements analytics
                let eventsQuery = supabaseClient
                    .from('analytics_events')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10000);

                // Si admin de soci√©t√©, filtrer par soci√©t√©
                if (currentUser.role === 'company_admin') {
                    const companyUsers = users.map(u => u.email);
                    eventsQuery = eventsQuery.in('user_email', companyUsers);
                }

                const { data: events, error: eventsError } = await eventsQuery;
                
                if (!eventsError && events) {
                    console.log(`[Data] ${events.length} √©v√©nements trouv√©s`);
                    allEvents = events;
                }
                
                // Traiter les donn√©es
                processData(users, events);
                
                // Mettre √† jour l'interface
                updateStats();
                populateFilters();
                renderCompaniesTable();
                
            } catch (error) {
                console.error('[Data] Erreur chargement:', error);
                showAlert('Erreur lors du chargement des donn√©es: ' + error.message, 'error');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function processData(users, events) {
            // Cr√©er une map des statistiques par utilisateur
            const userStatsMap = {};
            
            if (events) {
                events.forEach(event => {
                    if (event.user_email) {
                        if (!userStatsMap[event.user_email]) {
                            userStatsMap[event.user_email] = {
                                emailsScanned: 0,
                                sessions: new Set(),
                                lastActivity: event.created_at,
                                scanDays: new Set()
                            };
                        }
                        
                        if (event.event_type === 'email_scan' && event.event_data?.emailCount) {
                            userStatsMap[event.user_email].emailsScanned += event.event_data.emailCount;
                        }
                        
                        if (event.session_id) {
                            userStatsMap[event.user_email].sessions.add(event.session_id);
                        }
                        
                        // Ajouter le jour de scan pour calculer la fr√©quence
                        const scanDate = new Date(event.created_at).toDateString();
                        userStatsMap[event.user_email].scanDays.add(scanDate);
                        
                        if (new Date(event.created_at) > new Date(userStatsMap[event.user_email].lastActivity)) {
                            userStatsMap[event.user_email].lastActivity = event.created_at;
                        }
                    }
                });
            }
            
            // Traiter les utilisateurs
            allUsers = users.map(user => {
                const stats = userStatsMap[user.email] || {};
                const emailsScanned = stats.emailsScanned || 0;
                const scanDays = stats.scanDays ? stats.scanDays.size : 0;
                const avgScansPerDay = scanDays > 0 ? emailsScanned / scanDays : 0;
                
                // Calculer les dates de licence
                const licenseStartDate = user.license_start_date ? new Date(user.license_start_date) : new Date(user.created_at);
                const licenseEndDate = user.license_end_date ? new Date(user.license_end_date) : 
                    new Date(licenseStartDate.getTime() + (TRIAL_DAYS * 24 * 60 * 60 * 1000));
                
                const now = new Date();
                const daysUntilExpiry = Math.ceil((licenseEndDate - now) / (1000 * 60 * 60 * 24));
                
                return {
                    ...user,
                    emailsScanned,
                    sessionsCount: stats.sessions ? stats.sessions.size : 0,
                    lastActivity: stats.lastActivity || user.last_login_at || user.updated_at,
                    avgScansPerDay,
                    licenseStartDate,
                    licenseEndDate,
                    daysUntilExpiry,
                    scanFrequency: getScanFrequency(avgScansPerDay),
                    userType: getUserType(user.email, user.company)
                };
            });
            
            // Cr√©er les statistiques par domaine/soci√©t√©
            const domainMap = {};
            
            users.forEach(user => {
                const domain = user.company?.domain || user.email.split('@')[1];
                
                if (!domainMap[domain]) {
                    domainMap[domain] = {
                        domain: domain,
                        companyName: user.company?.name || domain,
                        companyId: user.company_id,
                        users: [],
                        adminEmail: null,
                        activeLicenses: 0,
                        monthlyRevenue: 0
                    };
                }
                
                domainMap[domain].users.push(user);
                
                if (user.role === 'company_admin' || user.role === 'super_admin') {
                    domainMap[domain].adminEmail = user.email;
                }
                
                if (user.license_status === 'active' || user.license_status === 'trial') {
                    domainMap[domain].activeLicenses++;
                    if (user.license_status === 'active') {
                        domainMap[domain].monthlyRevenue += MONTHLY_PRICE;
                    }
                }
            });
            
            allDomains = Object.values(domainMap);
        }

        function getUserType(email, company) {
            const domain = email.split('@')[1].toLowerCase();
            
            // Si l'utilisateur a une soci√©t√© d√©finie et ce n'est pas un domaine personnel
            if (company && company.name && !PERSONAL_DOMAINS.includes(domain)) {
                return 'professional';
            }
            
            // Si c'est un domaine personnel connu
            if (PERSONAL_DOMAINS.includes(domain)) {
                return 'personal';
            }
            
            // Par d√©faut, consid√©rer comme professionnel si ce n'est pas un domaine personnel connu
            return 'professional';
        }

        function getScanFrequency(avgScansPerDay) {
            if (avgScansPerDay === 0) return 'none';
            if (avgScansPerDay > 100) return 'high';
            if (avgScansPerDay > 10) return 'medium';
            return 'low';
        }

        function updateStats() {
            const activeUsers = allUsers.filter(u => 
                u.license_status === 'active' || u.license_status === 'trial'
            ).length;
            
            const activeLicenses = allUsers.filter(u => u.license_status === 'active').length;
            const totalDomains = allDomains.length;
            const totalEmails = allUsers.reduce((sum, user) => sum + user.emailsScanned, 0);
            
            // Calculs financiers
            const monthlyRevenue = allUsers
                .filter(u => u.license_status === 'active')
                .length * MONTHLY_PRICE;
            
            const yearlyRevenue = monthlyRevenue * 12;
            
            const unpaidUsers = allUsers.filter(u => 
                u.license_status === 'expired' && u.daysUntilExpiry < 0
            ).length;
            
            const trialUsers = allUsers.filter(u => u.license_status === 'trial').length;
            
            // Mettre √† jour l'interface
            document.getElementById('totalUsers').textContent = activeUsers;
            document.getElementById('totalLicenses').textContent = activeLicenses;
            document.getElementById('totalDomains').textContent = totalDomains;
            document.getElementById('totalEmails').textContent = totalEmails.toLocaleString();
            
            // Stats financi√®res
            if (document.getElementById('monthlyRevenue')) {
                document.getElementById('monthlyRevenue').textContent = monthlyRevenue.toFixed(2) + '‚Ç¨';
                document.getElementById('yearlyRevenue').textContent = yearlyRevenue.toFixed(2) + '‚Ç¨';
                document.getElementById('unpaidUsers').textContent = unpaidUsers;
                document.getElementById('trialUsers').textContent = trialUsers;
            }
        }

        function populateFilters() {
            // Peupler le filtre des soci√©t√©s dans l'onglet activit√©
            const companyFilter = document.getElementById('companyFilter');
            if (companyFilter) {
                const companies = [...new Set(allUsers.map(u => u.company?.name || 'Sans soci√©t√©'))];
                companyFilter.innerHTML = '<option value="">Toutes les soci√©t√©s</option>';
                companies.sort().forEach(company => {
                    companyFilter.innerHTML += `<option value="${company}">${company}</option>`;
                });
            }
            
            // Peupler le filtre des soci√©t√©s dans l'onglet licences
            const licenseCompanyFilter = document.getElementById('licenseCompanyFilter');
            if (licenseCompanyFilter) {
                const companies = [...new Set(allUsers.map(u => u.company?.name || 'Sans soci√©t√©'))];
                licenseCompanyFilter.innerHTML = '<option value="">Toutes les soci√©t√©s</option>';
                companies.sort().forEach(company => {
                    licenseCompanyFilter.innerHTML += `<option value="${company}">${company}</option>`;
                });
            }
        }

        // === RENDU DES TABLEAUX ===
        function renderCompaniesTable() {
            const tbody = document.getElementById('companiesTableBody');
            
            if (allDomains.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #718096;">Aucune soci√©t√© trouv√©e</td></tr>';
                return;
            }

            tbody.innerHTML = allDomains.map(domain => {
                const status = domain.activeLicenses > 0 ? 'active' : 'inactive';
                const hasTrialUsers = domain.users.some(u => u.license_status === 'trial');
                const displayStatus = hasTrialUsers ? 'trial' : status;
                
                return `
                    <tr>
                        <td><strong>${domain.companyName}</strong></td>
                        <td><span class="domain-badge">${domain.domain}</span></td>
                        <td><span class="user-count">${domain.users.length} utilisateurs</span></td>
                        <td>${domain.adminEmail || '-'}</td>
                        <td><span class="status-badge status-${displayStatus}">${displayStatus}</span></td>
                        <td><span class="license-badge license-active">${domain.activeLicenses}</span></td>
                        <td><strong>${domain.monthlyRevenue.toFixed(2)}‚Ç¨/mois</strong></td>
                    </tr>
                `;
            }).join('');
        }

        function renderActivityTable() {
            const tbody = document.getElementById('activityTableBody');
            
            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #718096;">Aucun utilisateur trouv√©</td></tr>';
                return;
            }

            tbody.innerHTML = allUsers.map(user => {
                const licenseClass = getLicenseClass(user.license_status);
                const frequencyClass = getFrequencyClass(user.scanFrequency);
                const frequencyLabel = getFrequencyLabel(user.scanFrequency);
                const userTypeClass = user.userType === 'professional' ? 'type-professional' : 'type-personal';
                const userTypeLabel = user.userType === 'professional' ? 'üè¢ Pro' : 'üë§ Particulier';
                
                return `
                    <tr data-company="${user.company?.name || 'Sans soci√©t√©'}" data-user-type="${user.userType}">
                        <td>
                            <strong>${user.name || user.email}</strong><br>
                            <small style="color: #6b7280;">${user.email}</small><br>
                            <span class="user-type-badge ${userTypeClass}">${userTypeLabel}</span>
                        </td>
                        <td>${user.company?.name || 'Sans soci√©t√©'}</td>
                        <td><span class="email-count">${user.emailsScanned.toLocaleString()}</span></td>
                        <td>${user.avgScansPerDay.toFixed(1)}</td>
                        <td><span class="frequency-badge ${frequencyClass}">${frequencyLabel}</span></td>
                        <td>${formatDate(user.lastActivity)}</td>
                        <td><span class="user-count">${user.sessionsCount}</span></td>
                        <td><span class="license-badge ${licenseClass}">${user.license_status || 'unknown'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function renderLicensesTable() {
            const tbody = document.getElementById('licensesTableBody');
            
            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #718096;">Aucun utilisateur trouv√©</td></tr>';
                return;
            }

            // Tri par d√©faut par nom
            const sortedUsers = [...allUsers].sort((a, b) => {
                const nameA = (a.name || a.email).toLowerCase();
                const nameB = (b.name || b.email).toLowerCase();
                return nameA.localeCompare(nameB);
            });

            tbody.innerHTML = sortedUsers.map(user => {
                const licenseClass = getLicenseClass(user.license_status);
                const daysClass = user.daysUntilExpiry < 0 ? 'expired' : 
                                 user.daysUntilExpiry < 7 ? 'warning' : 'success';
                const userTypeClass = user.userType === 'professional' ? 'type-professional' : 'type-personal';
                const userTypeLabel = user.userType === 'professional' ? 'üè¢ Pro' : 'üë§ Particulier';
                
                return `
                    <tr data-user-id="${user.id}" data-company="${user.company?.name || 'Sans soci√©t√©'}" data-user-type="${user.userType}" data-status="${user.license_status}">
                        <td>
                            <strong>${user.name || user.email}</strong><br>
                            <small style="color: #6b7280;">${user.email}</small>
                        </td>
                        <td><span class="user-type-badge ${userTypeClass}">${userTypeLabel}</span></td>
                        <td>${user.company?.name || 'Sans soci√©t√©'}</td>
                        <td><span class="license-badge ${licenseClass}">${user.license_status || 'unknown'}</span></td>
                        <td>${formatDateOnly(user.licenseStartDate)}</td>
                        <td>
                            ${canEditUser(user) ? 
                                `<input type="date" class="inline-edit" value="${user.licenseEndDate.toISOString().split('T')[0]}" 
                                        onchange="updateLicenseEndDate('${user.id}', this.value)">` :
                                formatDateOnly(user.licenseEndDate)
                            }
                        </td>
                        <td>
                            <span class="license-badge license-${daysClass}">
                                ${user.daysUntilExpiry < 0 ? 
                                    `Expir√© (${Math.abs(user.daysUntilExpiry)} jours)` : 
                                    `${user.daysUntilExpiry} jours`
                                }
                            </span>
                        </td>
                        <td>
                            ${canEditUser(user) ? `
                                <div class="edit-actions">
                                    <button class="btn-success" onclick="extendLicense('${user.id}', 30)" title="Prolonger 30 jours">+30j</button>
                                    <button class="btn-warning" onclick="openLicenseModal('${user.id}')" title="Modifier licence">‚úèÔ∏è</button>
                                    <button class="btn-danger" onclick="confirmDeleteUser('${user.id}')" title="Supprimer utilisateur">üóëÔ∏è</button>
                                </div>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #718096;">Aucun utilisateur trouv√©</td></tr>';
                return;
            }

            tbody.innerHTML = allUsers.map(user => {
                const paymentStatus = getPaymentStatus(user);
                const monthlyAmount = user.license_status === 'active' ? MONTHLY_PRICE : 0;
                const adminContact = getAdminContact(user);
                const overdueDays = user.daysUntilExpiry < 0 ? Math.abs(user.daysUntilExpiry) : 0;
                
                return `
                    <tr>
                        <td>
                            <strong>${user.name || user.email}</strong><br>
                            <small style="color: #6b7280;">${user.email}</small>
                        </td>
                        <td>${user.company?.name || '-'}</td>
                        <td><span class="license-badge ${getPaymentStatusClass(paymentStatus)}">${paymentStatus}</span></td>
                        <td><strong>${monthlyAmount.toFixed(2)}‚Ç¨</strong></td>
                        <td>${formatDate(user.licenseEndDate)}</td>
                        <td>
                            ${overdueDays > 0 ? 
                                `<span class="license-badge license-expired">${overdueDays} jours</span>` : 
                                '-'
                            }
                        </td>
                        <td>
                            ${adminContact ? 
                                `<a href="mailto:${adminContact}" style="color: #4f46e5;">${adminContact}</a>` : 
                                '-'
                            }
                        </td>
                        <td>
                            <div class="edit-actions">
                                ${canEditUser(user) ? 
                                    `<button class="btn-primary" onclick="openPaymentModal('${user.id}')">G√©rer</button>` :
                                    `<button class="btn-secondary" onclick="openUserPaymentModal('${user.id}')">Voir</button>`
                                }
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // === FONCTIONS UTILITAIRES ===
        function canEditUser(user) {
            return currentUser.role === 'super_admin' || 
                   (currentUser.role === 'company_admin' && user.company_id === currentUser.company_id);
        }

        function getAdminContact(user) {
            if (currentUser.role === 'super_admin') {
                const domain = allDomains.find(d => d.companyId === user.company_id);
                return domain?.adminEmail;
            }
            return null;
        }

        function getPaymentStatus(user) {
            if (user.license_status === 'trial') return 'Essai gratuit';
            if (user.license_status === 'active') return 'Pay√©';
            if (user.daysUntilExpiry < 0) return 'En retard';
            return 'Impay√©';
        }

        function getPaymentStatusClass(status) {
            switch(status) {
                case 'Pay√©': return 'license-active';
                case 'Essai gratuit': return 'license-trial';
                case 'En retard': return 'license-expired';
                default: return 'license-blocked';
            }
        }

        function getLicenseClass(status) {
            switch (status) {
                case 'active': return 'license-active';
                case 'trial': return 'license-trial';
                case 'expired': return 'license-expired';
                case 'blocked': return 'license-blocked';
                default: return 'license-expired';
            }
        }

        function getFrequencyClass(frequency) {
            switch (frequency) {
                case 'high': return 'frequency-high';
                case 'medium': return 'frequency-medium';
                case 'low': return 'frequency-low';
                default: return 'frequency-none';
            }
        }

        function getFrequencyLabel(frequency) {
            switch (frequency) {
                case 'high': return '√âlev√©e';
                case 'medium': return 'Moyenne';
                case 'low': return 'Faible';
                default: return 'Inactive';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Jamais';
            
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) {
                return `Il y a ${minutes} min`;
            } else if (hours < 24) {
                return `Il y a ${hours}h`;
            } else if (days < 7) {
                return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
            } else {
                return date.toLocaleDateString('fr-FR');
            }
        }

        function formatDateOnly(dateString) {
            if (!dateString) return 'Jamais';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // === FONCTIONS DE FILTRAGE ===
        function filterCompanies() {
            const searchTerm = document.getElementById('companySearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('#companiesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = text.includes(searchTerm);
                const matchesStatus = !statusFilter || text.includes(statusFilter);
                
                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            });
        }

        function filterActivity() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const frequencyFilter = document.getElementById('frequencyFilter').value;
            const companyFilter = document.getElementById('companyFilter').value;
            const rows = document.querySelectorAll('#activityTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowCompany = row.getAttribute('data-company');
                const rowUserType = row.getAttribute('data-user-type');
                
                const matchesSearch = text.includes(searchTerm);
                const matchesFrequency = !frequencyFilter || text.includes(getFrequencyLabel(frequencyFilter).toLowerCase());
                const matchesCompany = !companyFilter || rowCompany === companyFilter;
                
                row.style.display = matchesSearch && matchesFrequency && matchesCompany ? '' : 'none';
            });
        }

        function filterLicenses() {
            const searchTerm = document.getElementById('licenseSearch').value.toLowerCase();
            const companyFilter = document.getElementById('licenseCompanyFilter').value;
            const statusFilter = document.getElementById('licenseStatusFilter').value;
            const expiryFilter = document.getElementById('expiryFilter').value;
            const userTypeFilter = document.getElementById('userTypeFilter').value;
            const rows = document.querySelectorAll('#licensesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowCompany = row.getAttribute('data-company');
                const rowUserType = row.getAttribute('data-user-type');
                const rowStatus = row.getAttribute('data-status');
                
                const matchesSearch = text.includes(searchTerm);
                const matchesCompany = !companyFilter || rowCompany === companyFilter;
                const matchesStatus = !statusFilter || rowStatus === statusFilter;
                const matchesUserType = !userTypeFilter || rowUserType === userTypeFilter;
                
                let matchesExpiry = true;
                if (expiryFilter) {
                    const userId = row.getAttribute('data-user-id');
                    const user = allUsers.find(u => u.id === userId);
                    if (user) {
                        switch(expiryFilter) {
                            case 'expired':
                                matchesExpiry = user.daysUntilExpiry < 0;
                                break;
                            case 'soon':
                                matchesExpiry = user.daysUntilExpiry >= 0 && user.daysUntilExpiry <= 7;
                                break;
                            case 'month':
                                matchesExpiry = user.daysUntilExpiry >= 0 && user.daysUntilExpiry <= 30;
                                break;
                        }
                    }
                }
                
                row.style.display = matchesSearch && matchesCompany && matchesStatus && matchesExpiry && matchesUserType ? '' : 'none';
            });
        }

        function sortLicenses() {
            const sortBy = document.getElementById('sortFilter').value;
            const tbody = document.getElementById('licensesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const userIdA = a.getAttribute('data-user-id');
                const userIdB = b.getAttribute('data-user-id');
                const userA = allUsers.find(u => u.id === userIdA);
                const userB = allUsers.find(u => u.id === userIdB);
                
                if (!userA || !userB) return 0;
                
                switch(sortBy) {
                    case 'name':
                        const nameA = (userA.name || userA.email).toLowerCase();
                        const nameB = (userB.name || userB.email).toLowerCase();
                        return nameA.localeCompare(nameB);
                    
                    case 'company':
                        const companyA = (userA.company?.name || 'zzz').toLowerCase();
                        const companyB = (userB.company?.name || 'zzz').toLowerCase();
                        return companyA.localeCompare(companyB);
                    
                    case 'expiry':
                        return userA.daysUntilExpiry - userB.daysUntilExpiry;
                    
                    case 'status':
                        const statusA = userA.license_status || 'zzz';
                        const statusB = userB.license_status || 'zzz';
                        return statusA.localeCompare(statusB);
                    
                    default:
                        return 0;
                }
            });
            
            // R√©organiser les lignes
            rows.forEach(row => tbody.appendChild(row));
        }

        function filterPayments() {
            const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
            const statusFilter = document.getElementById('paymentStatusFilter').value;
            const rows = document.querySelectorAll('#paymentsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = text.includes(searchTerm);
                const matchesStatus = !statusFilter || text.includes(statusFilter.toLowerCase());
                
                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            });
        }

        // === GESTION DES UTILISATEURS ===
        async function confirmDeleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user || !canEditUser(user)) {
                showAlert('Vous n\'avez pas les droits pour supprimer cet utilisateur', 'error');
                return;
            }

            const confirmMessage = `√ätes-vous s√ªr de vouloir supprimer d√©finitivement l'utilisateur ?\n\n` +
                                  `Email: ${user.email}\n` +
                                  `Nom: ${user.name || 'Non d√©fini'}\n` +
                                  `Soci√©t√©: ${user.company?.name || 'Aucune'}\n\n` +
                                  `‚ö†Ô∏è Cette action est irr√©versible !`;

            if (!confirm(confirmMessage)) {
                return;
            }

            await deleteUser(userId);
        }

        async function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user || !canEditUser(user)) {
                showAlert('Vous n\'avez pas les droits pour supprimer cet utilisateur', 'error');
                return;
            }

            try {
                // Supprimer d'abord les √©v√©nements analytics li√©s √† l'utilisateur
                const { error: eventsError } = await supabaseClient
                    .from('analytics_events')
                    .delete()
                    .eq('user_email', user.email);

                if (eventsError) {
                    console.warn('[Delete] Erreur suppression √©v√©nements:', eventsError);
                    // On continue malgr√© l'erreur pour les √©v√©nements
                }

                // Supprimer l'utilisateur
                const { error: userError } = await supabaseClient
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (userError) throw userError;

                showAlert(`Utilisateur ${user.email} supprim√© avec succ√®s`, 'success');
                await loadDashboardData();
                
            } catch (error) {
                console.error('[Delete] Erreur suppression utilisateur:', error);
                showAlert('Erreur lors de la suppression: ' + error.message, 'error');
            }
        }
        async function updateLicenseEndDate(userId, newEndDate) {
            if (!canEditUser(allUsers.find(u => u.id === userId))) {
                showAlert('Vous n\'avez pas les droits pour modifier cette licence', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('users')
                    .update({ 
                        license_end_date: newEndDate,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                showAlert('Date d\'expiration mise √† jour avec succ√®s', 'success');
                await loadDashboardData();
                
            } catch (error) {
                console.error('[License] Erreur mise √† jour:', error);
                showAlert('Erreur lors de la mise √† jour: ' + error.message, 'error');
            }
        }

        async function extendLicense(userId, days) {
            const user = allUsers.find(u => u.id === userId);
            if (!user || !canEditUser(user)) {
                showAlert('Vous n\'avez pas les droits pour modifier cette licence', 'error');
                return;
            }

            try {
                const currentEndDate = new Date(user.licenseEndDate);
                const newEndDate = new Date(currentEndDate.getTime() + (days * 24 * 60 * 60 * 1000));

                const { error } = await supabaseClient
                    .from('users')
                    .update({ 
                        license_end_date: newEndDate.toISOString(),
                        license_status: 'active',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                showAlert(`Licence prolong√©e de ${days} jours avec succ√®s`, 'success');
                await loadDashboardData();
                
            } catch (error) {
                console.error('[License] Erreur prolongation:', error);
                showAlert('Erreur lors de la prolongation: ' + error.message, 'error');
            }
        }

        function openLicenseModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('licenseModal');
            const content = document.getElementById('licenseModalContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h4>${user.name || user.email}</h4>
                    <p style="color: #6b7280;">${user.company?.name || 'Aucune soci√©t√©'}</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Statut de la licence</label>
                    <select class="form-input" id="licenseStatus">
                        <option value="trial" ${user.license_status === 'trial' ? 'selected' : ''}>Essai gratuit</option>
                        <option value="active" ${user.license_status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="expired" ${user.license_status === 'expired' ? 'selected' : ''}>Expir√©e</option>
                        <option value="blocked" ${user.license_status === 'blocked' ? 'selected' : ''}>Bloqu√©e</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date de d√©but</label>
                    <input type="date" class="form-input" id="licenseStartDate" 
                           value="${user.licenseStartDate.toISOString().split('T')[0]}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date d'expiration</label>
                    <input type="date" class="form-input" id="licenseEndDate" 
                           value="${user.licenseEndDate.toISOString().split('T')[0]}">
                </div>
                
                <div class="trial-info">
                    <strong>Prix:</strong> ${MONTHLY_PRICE}‚Ç¨ HT/mois<br>
                    <strong>Essai gratuit:</strong> ${TRIAL_DAYS} jours
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn-primary" onclick="saveLicenseChanges('${userId}')">
                        Sauvegarder
                    </button>
                    <button class="btn-secondary" onclick="closeLicenseModal()">
                        Annuler
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeLicenseModal() {
            document.getElementById('licenseModal').style.display = 'none';
        }

        async function saveLicenseChanges(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user || !canEditUser(user)) {
                showAlert('Vous n\'avez pas les droits pour modifier cette licence', 'error');
                return;
            }

            try {
                const status = document.getElementById('licenseStatus').value;
                const startDate = document.getElementById('licenseStartDate').value;
                const endDate = document.getElementById('licenseEndDate').value;

                const { error } = await supabaseClient
                    .from('users')
                    .update({ 
                        license_status: status,
                        license_start_date: startDate,
                        license_end_date: endDate,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                showAlert('Licence mise √† jour avec succ√®s', 'success');
                closeLicenseModal();
                await loadDashboardData();
                
            } catch (error) {
                console.error('[License] Erreur sauvegarde:', error);
                showAlert('Erreur lors de la sauvegarde: ' + error.message, 'error');
            }
        }

        // === GESTION DES PAIEMENTS ===
        function openPaymentModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('paymentModal');
            const content = document.getElementById('paymentModalContent');
            
            const monthlyAmount = user.license_status === 'active' ? MONTHLY_PRICE : 0;
            const yearlyAmount = monthlyAmount * 12;
            const overdueDays = user.daysUntilExpiry < 0 ? Math.abs(user.daysUntilExpiry) : 0;
            const overdueAmount = overdueDays > 0 ? (Math.ceil(overdueDays / 30) * MONTHLY_PRICE) : 0;
            
            content.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h4>${user.name || user.email}</h4>
                    <p style="color: #6b7280;">${user.company?.name || 'Aucune soci√©t√©'}</p>
                </div>
                
                <div class="payment-info">
                    <div class="price-display">${MONTHLY_PRICE}‚Ç¨ HT/mois</div>
                    <div style="text-align: center; color: #6b7280;">
                        ${yearlyAmount.toFixed(2)}‚Ç¨ HT/an
                    </div>
                </div>
                
                ${user.license_status === 'trial' ? `
                    <div class="trial-info">
                        <i class="fas fa-clock"></i>
                        P√©riode d'essai gratuit de ${TRIAL_DAYS} jours<br>
                        ${user.daysUntilExpiry > 0 ? 
                            `Expire dans ${user.daysUntilExpiry} jours` : 
                            'P√©riode d\'essai expir√©e'
                        }
                    </div>
                ` : ''}
                
                ${overdueDays > 0 ? `
                    <div class="expiry-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Paiement en retard de ${overdueDays} jours<br>
                        <strong>Montant d√ª: ${overdueAmount.toFixed(2)}‚Ç¨ HT</strong>
                    </div>
                ` : ''}
                
                <div class="payment-history">
                    <h4>Actions de paiement</h4>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="btn-success" onclick="markAsPaid('${userId}')">
                            <i class="fas fa-check"></i> Marquer comme pay√©
                        </button>
                        <button class="btn-warning" onclick="extendLicense('${userId}', 30)">
                            <i class="fas fa-calendar-plus"></i> Prolonger 30 jours
                        </button>
                        <button class="btn-primary" onclick="sendPaymentReminder('${userId}')">
                            <i class="fas fa-envelope"></i> Rappel de paiement
                        </button>
                        ${currentUser.role === 'super_admin' ? `
                            <button class="btn-danger" onclick="suspendUser('${userId}')">
                                <i class="fas fa-ban"></i> Suspendre
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <button class="btn-secondary" onclick="closePaymentModal()">
                        Fermer
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        function openUserPaymentModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('userPaymentModal');
            const content = document.getElementById('userPaymentModalContent');
            
            const adminContact = getAdminContact(user);
            const overdueDays = user.daysUntilExpiry < 0 ? Math.abs(user.daysUntilExpiry) : 0;
            
            content.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h4>Information de Paiement</h4>
                    <p style="color: #6b7280;">${user.name || user.email}</p>
                </div>
                
                <div class="payment-info">
                    <div class="price-display">${MONTHLY_PRICE}‚Ç¨ HT/mois</div>
                    <div style="text-align: center; color: #6b7280;">
                        Abonnement EmailSortPro
                    </div>
                </div>
                
                ${user.license_status === 'trial' ? `
                    <div class="trial-info">
                        <i class="fas fa-gift"></i>
                        Vous b√©n√©ficiez actuellement de ${TRIAL_DAYS} jours d'essai gratuit<br>
                        ${user.daysUntilExpiry > 0 ? 
                            `Il vous reste ${user.daysUntilExpiry} jours d'essai` : 
                            'Votre p√©riode d\'essai est expir√©e'
                        }
                    </div>
                ` : ''}
                
                ${user.license_status === 'expired' || overdueDays > 0 ? `
                    <div class="expiry-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Votre licence a expir√© ${overdueDays > 0 ? `il y a ${overdueDays} jours` : ''}<br>
                        Pour continuer √† utiliser EmailSortPro, veuillez r√©gulariser votre situation.
                    </div>
                ` : ''}
                
                ${adminContact ? `
                    <div class="contact-admin">
                        <i class="fas fa-user-tie"></i>
                        <strong>Contactez votre administrateur:</strong><br>
                        <a href="mailto:${adminContact}" style="color: #4f46e5; font-weight: 600;">
                            ${adminContact}
                        </a><br>
                        <small>Votre administrateur peut g√©rer les paiements et prolonger votre licence.</small>
                    </div>
                ` : ''}
                
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="btn-primary" onclick="initiateStripePayment('${userId}')">
                        <i class="fas fa-credit-card"></i> Payer avec Stripe
                    </button>
                </div>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn-secondary" onclick="closeUserPaymentModal()">
                        Fermer
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeUserPaymentModal() {
            document.getElementById('userPaymentModal').style.display = 'none';
        }

        async function markAsPaid(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user || !canEditUser(user)) {
                showAlert('Vous n\'avez pas les droits pour modifier ce paiement', 'error');
                return;
            }

            try {
                const newEndDate = new Date();
                newEndDate.setMonth(newEndDate.getMonth() + 1);

                const { error } = await supabaseClient
                    .from('users')
                    .update({ 
                        license_status: 'active',
                        license_end_date: newEndDate.toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                showAlert('Paiement enregistr√© avec succ√®s', 'success');
                closePaymentModal();
                await loadDashboardData();
                
            } catch (error) {
                console.error('[Payment] Erreur enregistrement paiement:', error);
                showAlert('Erreur lors de l\'enregistrement: ' + error.message, 'error');
            }
        }

        async function sendPaymentReminder(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            try {
                // Ici vous pourriez int√©grer un service d'email
                // Pour l'instant, on simule l'envoi
                console.log(`[Payment] Envoi rappel √† ${user.email}`);
                
                showAlert('Rappel de paiement envoy√© avec succ√®s', 'success');
                
            } catch (error) {
                console.error('[Payment] Erreur envoi rappel:', error);
                showAlert('Erreur lors de l\'envoi du rappel', 'error');
            }
        }

        async function suspendUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user || currentUser.role !== 'super_admin') {
                showAlert('Seul le super admin peut suspendre un utilisateur', 'error');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir suspendre cet utilisateur ?')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('users')
                    .update({ 
                        license_status: 'blocked',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                showAlert('Utilisateur suspendu avec succ√®s', 'success');
                closePaymentModal();
                await loadDashboardData();
                
            } catch (error) {
                console.error('[Payment] Erreur suspension:', error);
                showAlert('Erreur lors de la suspension: ' + error.message, 'error');
            }
        }

        function initiateStripePayment(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            // Simuler l'int√©gration Stripe
            // Dans un vrai projet, vous initialiseriez Stripe ici
            alert(`Redirection vers Stripe pour le paiement de ${MONTHLY_PRICE}‚Ç¨ HT\nUtilisateur: ${user.email}`);
            
            // Vous pourriez rediriger vers votre checkout Stripe :
            // window.location.href = `/stripe-checkout?userId=${userId}&amount=${MONTHLY_PRICE}`;
        }

        // === FONCTIONS D'EXPORT ===
        function exportPayments() {
            const csvContent = generatePaymentsCSV();
            downloadCSV(csvContent, 'payments-export.csv');
        }

        function generatePaymentsCSV() {
            const headers = ['Email', 'Nom', 'Soci√©t√©', 'Statut Licence', 'Statut Paiement', 'Montant Mensuel', 'Date Expiration', 'Jours Retard'];
            
            const rows = allUsers.map(user => {
                const paymentStatus = getPaymentStatus(user);
                const monthlyAmount = user.license_status === 'active' ? MONTHLY_PRICE : 0;
                const overdueDays = user.daysUntilExpiry < 0 ? Math.abs(user.daysUntilExpiry) : 0;
                
                return [
                    user.email,
                    user.name || '',
                    user.company?.name || '',
                    user.license_status || '',
                    paymentStatus,
                    monthlyAmount.toFixed(2) + '‚Ç¨',
                    user.licenseEndDate.toLocaleDateString('fr-FR'),
                    overdueDays || ''
                ].join(',');
            });
            
            return [headers.join(','), ...rows].join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // === FONCTIONS PRINCIPALES ===
        function refreshData() {
            loadDashboardData();
        }

        console.log('[Analytics] ‚úÖ Analytics Admin Enhanced initialis√©');
    </script>
</body>
</html>
