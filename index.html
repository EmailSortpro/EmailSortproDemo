<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmailSortProAI - Scanner d'Emails Intelligent avec IA</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Organisez vos emails Outlook et Gmail intelligemment avec l'IA. Cat√©gorisation automatique et organisation par domaine.">
    <meta name="keywords" content="email, outlook, gmail, microsoft, google, gestion, ia, productivit√©, organisation">
    <meta name="author" content="VH - Vianney Hastings">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:title" content="EmailSortProAI - Scanner d'Emails Intelligent">
    <meta property="og:description" content="Organisez vos emails Outlook et Gmail intelligemment avec l'IA.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="">
    <meta property="twitter:title" content="EmailSortProAI - Scanner d'Emails Intelligent">
    <meta property="twitter:description" content="Organisez vos emails Outlook et Gmail intelligemment avec l'IA.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìß</text></svg>">
    
    <!-- MSAL Library -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CONFIGURATION NETLIFY DYNAMIQUE -->
    <script>
        console.log('[INDEX] üöÄ Loading dynamic Netlify configuration...');
        
        // D√©tection automatique du domaine actuel
        const currentDomain = window.location.hostname;
        const currentOrigin = window.location.origin;
        
        console.log('[INDEX] üåê Domaine d√©tect√©:', currentDomain);
        console.log('[INDEX] üåê Origin d√©tect√©:', currentOrigin);
        
        // Client ID fonctionnel pour tous les domaines Netlify
        window.NETLIFY_CLIENT_ID = '8fec3ae1-78e3-4b5d-a425-00b8f20516f7';
        
        console.log('[INDEX] ‚úÖ Client ID configur√© pour domaine Netlify');
        
        // D√©tection de l'environnement
        (function() {
            const hostname = window.location.hostname;
            const isNetlify = hostname.includes('netlify.app') || hostname.includes('netlifyapp.com');
            const isGitHubPages = hostname.includes('github.io');
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
            
            console.log('[INDEX] Environment detection:', {
                hostname,
                isNetlify,
                isGitHubPages,
                isLocalhost,
                origin: window.location.origin
            });
            
            // Fonction pour obtenir le Client ID
            function getClientIdForEnvironment() {
                if (isNetlify) {
                    console.log('[INDEX] ‚úÖ Using Netlify client ID');
                    return window.NETLIFY_CLIENT_ID;
                }
                
                try {
                    const savedClientId = localStorage.getItem('emailsortpro_client_id');
                    if (savedClientId && savedClientId !== 'VOTRE_CLIENT_ID_ICI' && savedClientId !== 'CONFIGURATION_REQUIRED') {
                        console.log('[INDEX] ‚úÖ Using saved client ID from localStorage');
                        return savedClientId;
                    }
                } catch (e) {
                    console.warn('[INDEX] Cannot access localStorage:', e);
                }
                
                if (isLocalhost) {
                    console.log('[INDEX] Using localhost development client ID');
                    return '8fec3ae1-78e3-4b5d-a425-00b8f20516f7';
                }
                
                console.log('[INDEX] ‚úÖ Using default client ID');
                return '8fec3ae1-78e3-4b5d-a425-00b8f20516f7';
            }
            
            // Fonction pour cr√©er la configuration dynamique
            function createConfig(clientId) {
                const redirectUri = currentOrigin + '/auth-callback.html';
                const postLogoutRedirectUri = currentOrigin + '/';
                
                console.log('[INDEX] Creating dynamic config:', {
                    redirectUri,
                    postLogoutRedirectUri,
                    clientId: clientId.substring(0, 8) + '...',
                    currentDomain: hostname
                });
                
                window.AppConfig = {
                    msal: {
                        clientId: clientId,
                        authority: 'https://login.microsoftonline.com/common',
                        redirectUri: redirectUri,
                        postLogoutRedirectUri: postLogoutRedirectUri,
                        cache: {
                            cacheLocation: 'localStorage',
                            storeAuthStateInCookie: true
                        },
                        system: {
                            loggerOptions: {
                                loggerCallback: (level, message, containsPii) => {
                                    if (window.debugMode || isLocalhost) {
                                        console.log(`[MSAL ${level}] ${message}`);
                                    }
                                },
                                piiLoggingEnabled: false,
                                logLevel: isLocalhost ? 'Verbose' : 'Warning'
                            },
                            allowNativeBroker: false
                        }
                    },
                    scopes: {
                        login: [
                            'https://graph.microsoft.com/User.Read',
                            'https://graph.microsoft.com/Mail.Read',
                            'https://graph.microsoft.com/Mail.ReadWrite'
                        ],
                        silent: [
                            'https://graph.microsoft.com/User.Read',
                            'https://graph.microsoft.com/Mail.Read',
                            'https://graph.microsoft.com/Mail.ReadWrite'
                        ]
                    },
                    app: {
                        name: 'EmailSortProAI',
                        version: '3.0.4',
                        debug: isLocalhost,
                        environment: isNetlify ? 'netlify' : isGitHubPages ? 'github' : isLocalhost ? 'localhost' : 'other',
                        domain: hostname,
                        currentUrl: currentOrigin
                    },
                    email: {
                        defaultFolder: 'inbox',
                        defaultDays: 30,
                        pageSize: 100,
                        maxEmails: 10000
                    },
                    validate() {
                        const issues = [];
                        if (!this.msal.clientId || this.msal.clientId === 'VOTRE_CLIENT_ID_ICI' || this.msal.clientId === 'CONFIGURATION_REQUIRED') {
                            issues.push('Client ID non configur√©');
                        }
                        
                        return { 
                            valid: issues.length === 0, 
                            issues: issues 
                        };
                    }
                };
                
                console.log('[INDEX] ‚úÖ Configuration cr√©√©e pour:', {
                    environment: window.AppConfig.app.environment,
                    domain: window.AppConfig.app.domain,
                    clientId: clientId.substring(0, 8) + '...',
                    redirectUri: window.AppConfig.msal.redirectUri
                });
            }
            
            // Cr√©er la configuration
            const clientId = getClientIdForEnvironment();
            createConfig(clientId);
            
            console.log('[INDEX] ‚úÖ Configuration termin√©e pour:', hostname);
        })();

        // SYST√àME DE LICENCE AVEC CONTR√îLE STRICT ET BLOCAGE R√âEL
        window.StrictLicenseSystem = {
            initialized: false,
            currentUser: null,
            isBlocked: false,
            licenseStatus: null,
            
            // Configuration des super admins
            SUPER_ADMINS: [
                'vianney.hastings@hotmail.fr',
                'admin@emailsortpro.com',
                'vianneyhastings@emailsortpro.fr'
            ],
            
            // Configuration des licences de test (LIMIT√â)
            TEST_USERS: {
                'vianney.hastings@hotmail.fr': {
                    unlimited: true,
                    superAdmin: true
                }
                // Aucun autre utilisateur de test - TOUS doivent payer apr√®s 15 jours
            },
            
            async init() {
                console.log('[STRICT_LICENSE] üöÄ Initialisation du syst√®me de licence STRICT v5.0');
                this.initialized = true;
                
                // Nettoyer les anciennes donn√©es si n√©cessaire
                this.cleanupExpiredSessions();
                
                return true;
            },
            
            async checkLicense(email) {
                console.log('[STRICT_LICENSE] üîç V√©rification licence STRICTE pour:', email);
                
                if (!email || !this.isValidEmail(email)) {
                    throw new Error('Email invalide fourni');
                }
                
                const cleanEmail = email.toLowerCase().trim();
                
                // 1. V√©rifier si super admin
                if (this.isSuperAdmin(cleanEmail)) {
                    console.log('[STRICT_LICENSE] üëë SUPER ADMIN d√©tect√© - Acc√®s illimit√©');
                    return this.createLicenseResult(true, 'super_admin', 'Acc√®s super administrateur', 999);
                }
                
                // 2. V√©rifier si utilisateur de test autoris√©
                if (this.isTestUser(cleanEmail)) {
                    console.log('[STRICT_LICENSE] üß™ Utilisateur de test autoris√©');
                    return this.createLicenseResult(true, 'test_unlimited', 'Acc√®s de test illimit√©', 999);
                }
                
                // 3. R√©cup√©rer ou cr√©er l'utilisateur
                let user = this.getUser(cleanEmail);
                
                if (!user) {
                    // NOUVEAU UTILISATEUR - Cr√©er avec 15 jours SEULEMENT
                    console.log('[STRICT_LICENSE] üÜï Cr√©ation nouveau compte avec 15 jours d\'essai UNIQUEMENT');
                    user = this.createNewUser(cleanEmail);
                } else {
                    // Utilisateur existant - mettre √† jour la derni√®re connexion
                    user.lastLoginAt = new Date().toISOString();
                    this.saveUser(user);
                    console.log('[STRICT_LICENSE] üë§ Utilisateur existant reconnect√©');
                }
                
                // 4. V√âRIFICATION STRICTE DE LA DATE D'EXPIRATION
                const licenseCheck = this.evaluateLicense(user);
                
                if (!licenseCheck.valid) {
                    console.error('[STRICT_LICENSE] ‚ùå LICENCE EXPIR√âE - BLOCAGE IMM√âDIAT');
                    this.isBlocked = true;
                    
                    // Sauvegarder l'√©tat de blocage
                    this.currentUser = user;
                    this.licenseStatus = licenseCheck;
                    
                    return licenseCheck;
                }
                
                // 5. Licence valide
                this.currentUser = user;
                this.licenseStatus = licenseCheck;
                this.isBlocked = false;
                
                console.log('[STRICT_LICENSE] ‚úÖ Licence valide:', {
                    email: user.email,
                    status: licenseCheck.status,
                    daysRemaining: licenseCheck.daysRemaining,
                    expiresAt: user.licenseExpiresAt
                });
                
                return licenseCheck;
            },
            
            createNewUser(email) {
                const now = new Date();
                const expirationDate = new Date(now.getTime() + (15 * 24 * 60 * 60 * 1000)); // 15 jours EXACTEMENT
                
                const user = {
                    email: email,
                    name: email.split('@')[0],
                    licenseStatus: 'trial',
                    licenseExpiresAt: expirationDate.toISOString(),
                    paymentStatus: 'trial',
                    createdAt: now.toISOString(),
                    lastLoginAt: now.toISOString(),
                    trialUsed: true, // Marquer que l'essai a √©t√© utilis√©
                    company: this.getCompanyFromEmail(email)
                };
                
                this.saveUser(user);
                
                console.log('[STRICT_LICENSE] üíæ Nouveau utilisateur cr√©√©:', {
                    email: user.email,
                    expiresAt: user.licenseExpiresAt,
                    daysGranted: 15
                });
                
                return user;
            },
            
            evaluateLicense(user) {
                const now = new Date();
                const expiresAt = new Date(user.licenseExpiresAt);
                const daysRemaining = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                
                console.log('[STRICT_LICENSE] üìÖ √âvaluation licence:', {
                    email: user.email,
                    now: now.toISOString(),
                    expiresAt: expiresAt.toISOString(),
                    daysRemaining: daysRemaining,
                    paymentStatus: user.paymentStatus
                });
                
                // V√âRIFICATION STRICTE : Si expir√©, BLOQUER
                if (expiresAt < now) {
                    const daysOverdue = Math.ceil((now - expiresAt) / (1000 * 60 * 60 * 24));
                    
                    return this.createLicenseResult(
                        false, 
                        'expired', 
                        `Votre p√©riode d'essai de 15 jours a expir√© il y a ${daysOverdue} jour${daysOverdue > 1 ? 's' : ''}. Contactez support@emailsortpro.com pour obtenir une licence payante.`,
                        0,
                        {
                            isBlocked: true,
                            daysOverdue: daysOverdue,
                            contactRequired: true
                        }
                    );
                }
                
                // Licence pay√©e et valide
                if (user.paymentStatus === 'paid') {
                    return this.createLicenseResult(
                        true,
                        'paid_active',
                        'Licence pay√©e active',
                        daysRemaining
                    );
                }
                
                // P√©riode d'essai active
                if (user.licenseStatus === 'trial') {
                    let message = `P√©riode d'essai gratuite - ${daysRemaining} jour${daysRemaining > 1 ? 's' : ''} restant${daysRemaining > 1 ? 's' : ''}`;
                    
                    if (daysRemaining <= 3) {
                        message += ` ‚ö†Ô∏è URGENT: Votre essai expire bient√¥t! Contactez support@emailsortpro.com pour continuer √† utiliser l'application.`;
                    } else if (daysRemaining <= 7) {
                        message += ` ‚ö†Ô∏è Pr√©parez votre achat - Contactez support@emailsortpro.com`;
                    }
                    
                    return this.createLicenseResult(
                        true,
                        'trial_active',
                        message,
                        daysRemaining,
                        {
                            warningLevel: daysRemaining <= 3 ? 'critical' : daysRemaining <= 7 ? 'high' : 'normal'
                        }
                    );
                }
                
                // Statut invalide
                return this.createLicenseResult(
                    false,
                    'invalid_status',
                    'Statut de licence invalide. Contactez le support.',
                    0,
                    { isBlocked: true }
                );
            },
            
            createLicenseResult(valid, status, message, daysRemaining, extra = {}) {
                return {
                    valid: valid,
                    status: status,
                    message: message,
                    daysRemaining: daysRemaining,
                    timestamp: new Date().toISOString(),
                    ...extra
                };
            },
            
            // Fonctions utilitaires
            isSuperAdmin(email) {
                return this.SUPER_ADMINS.includes(email.toLowerCase());
            },
            
            isTestUser(email) {
                return this.TEST_USERS.hasOwnProperty(email.toLowerCase());
            },
            
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },
            
            getCompanyFromEmail(email) {
                const domain = email.split('@')[1];
                const personalDomains = [
                    'gmail.com', 'yahoo.com', 'hotmail.com', 'hotmail.fr',
                    'outlook.com', 'live.com', 'icloud.com', 'free.fr'
                ];
                
                if (personalDomains.includes(domain.toLowerCase())) {
                    return { name: `Personnel - ${email}`, domain: domain, type: 'personal' };
                } else {
                    return { name: domain, domain: domain, type: 'business' };
                }
            },
            
            // Stockage local s√©curis√©
            getUser(email) {
                try {
                    const users = JSON.parse(localStorage.getItem('emailsortpro_strict_users') || '{}');
                    return users[email.toLowerCase()] || null;
                } catch (error) {
                    console.warn('[STRICT_LICENSE] Erreur lecture utilisateur:', error);
                    return null;
                }
            },
            
            saveUser(user) {
                try {
                    const users = JSON.parse(localStorage.getItem('emailsortpro_strict_users') || '{}');
                    users[user.email.toLowerCase()] = user;
                    localStorage.setItem('emailsortpro_strict_users', JSON.stringify(users));
                    
                    // Sauvegarder aussi la derni√®re v√©rification
                    localStorage.setItem('emailsortpro_last_check', new Date().toISOString());
                    localStorage.setItem('emailsortpro_last_user', user.email);
                    
                    console.log('[STRICT_LICENSE] üíæ Utilisateur sauvegard√©:', user.email);
                } catch (error) {
                    console.error('[STRICT_LICENSE] Erreur sauvegarde:', error);
                }
            },
            
            cleanupExpiredSessions() {
                try {
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - 90); // Nettoyer les sessions de plus de 90 jours
                    
                    const users = JSON.parse(localStorage.getItem('emailsortpro_strict_users') || '{}');
                    let cleaned = 0;
                    
                    Object.keys(users).forEach(email => {
                        const user = users[email];
                        if (new Date(user.lastLoginAt || user.createdAt) < cutoffDate) {
                            delete users[email];
                            cleaned++;
                        }
                    });
                    
                    if (cleaned > 0) {
                        localStorage.setItem('emailsortpro_strict_users', JSON.stringify(users));
                        console.log(`[STRICT_LICENSE] üßπ ${cleaned} anciennes sessions nettoy√©es`);
                    }
                } catch (error) {
                    console.warn('[STRICT_LICENSE] Erreur nettoyage:', error);
                }
            },
            
            // FONCTIONS ADMIN POUR GESTION DES LICENCES
            markAsPaid(email, adminEmail) {
                if (!this.isSuperAdmin(adminEmail)) {
                    throw new Error('Seuls les super admins peuvent marquer comme pay√©');
                }
                
                const user = this.getUser(email);
                if (!user) {
                    throw new Error('Utilisateur non trouv√©');
                }
                
                // √âtendre la licence de 1 an
                const now = new Date();
                const newExpiration = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));
                
                user.paymentStatus = 'paid';
                user.licenseStatus = 'active';
                user.licenseExpiresAt = newExpiration.toISOString();
                user.paidAt = now.toISOString();
                user.paidBy = adminEmail;
                
                this.saveUser(user);
                
                console.log('[STRICT_LICENSE] üí≥ Licence pay√©e activ√©e pour:', email, 'jusqu\'au:', newExpiration.toLocaleDateString());
                return true;
            },
            
            getAllUsers() {
                try {
                    const users = JSON.parse(localStorage.getItem('emailsortpro_strict_users') || '{}');
                    
                    return Object.values(users).map(user => ({
                        email: user.email,
                        name: user.name,
                        licenseStatus: user.licenseStatus,
                        paymentStatus: user.paymentStatus,
                        licenseExpiresAt: user.licenseExpiresAt,
                        daysRemaining: Math.ceil((new Date(user.licenseExpiresAt) - new Date()) / (1000 * 60 * 60 * 24)),
                        isExpired: new Date(user.licenseExpiresAt) < new Date(),
                        createdAt: user.createdAt,
                        lastLoginAt: user.lastLoginAt
                    }));
                } catch (error) {
                    console.error('[STRICT_LICENSE] Erreur r√©cup√©ration utilisateurs:', error);
                    return [];
                }
            },
            
            // Interface publique pour l'application
            getCurrentUser() {
                return this.currentUser;
            },
            
            getCurrentStatus() {
                return this.licenseStatus;
            },
            
            isApplicationBlocked() {
                return this.isBlocked;
            }
        };

        // FONCTION DE V√âRIFICATION LICENCE INT√âGR√âE
        window.verifyLicense = async function(email = null) {
            console.log('[LICENSE_VERIFY] üöÄ D√©marrage v√©rification licence stricte...');
            
            try {
                // Initialiser le syst√®me s'il ne l'est pas
                if (!window.StrictLicenseSystem.initialized) {
                    await window.StrictLicenseSystem.init();
                }
                
                // D√©terminer l'email √† utiliser
                let userEmail = email;
                
                if (!userEmail) {
                    // ERREUR: Ne jamais demander d'email automatiquement
                    throw new Error('Email requis pour la v√©rification de licence');
                }
                
                // Valider et nettoyer l'email
                if (!window.StrictLicenseSystem.isValidEmail(userEmail)) {
                    throw new Error('Format d\'email invalide');
                }
                
                const cleanEmail = userEmail.toLowerCase().trim();
                
                // Sauvegarder l'email pour la prochaine fois
                try {
                    localStorage.setItem('emailsortpro_user_email', cleanEmail);
                } catch (storageError) {
                    console.warn('[LICENSE_VERIFY] Impossible de sauvegarder l\'email:', storageError);
                }
                
                // V√âRIFICATION STRICTE DE LA LICENCE
                const licenseResult = await window.StrictLicenseSystem.checkLicense(cleanEmail);
                
                console.log('[LICENSE_VERIFY] R√©sultat v√©rification:', licenseResult);
                
                // √âmettre les √©v√©nements appropri√©s
                if (licenseResult.valid) {
                    console.log('[LICENSE_VERIFY] ‚úÖ Licence valide - Autorisation d\'acc√®s');
                    
                    // √âmettre √©v√©nement de succ√®s
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('licenseVerified', {
                            detail: { 
                                user: window.StrictLicenseSystem.getCurrentUser(), 
                                license: licenseResult 
                            }
                        }));
                    }, 100);
                    
                    return true;
                } else {
                    console.error('[LICENSE_VERIFY] ‚ùå LICENCE INVALIDE - ACC√àS BLOQU√â');
                    
                    // √âmettre √©v√©nement de blocage
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('licenseBlocked', {
                            detail: { 
                                user: window.StrictLicenseSystem.getCurrentUser(), 
                                license: licenseResult 
                            }
                        }));
                    }, 100);
                    
                    return false;
                }
                
            } catch (error) {
                console.error('[LICENSE_VERIFY] ‚ùå Erreur critique:', error);
                
                // √âmettre √©v√©nement d'erreur
                setTimeout(() => {
                    window.dispatchEvent(new CustomEvent('licenseError', {
                        detail: { 
                            error: error.message,
                            timestamp: new Date().toISOString()
                        }
                    }));
                }, 100);
                
                return false;
            }
        };

        // FONCTION POUR V√âRIFIER LA LICENCE APR√àS CONNEXION
        window.verifyLicenseAfterLogin = async function(userEmail) {
            console.log('[LICENSE_POST_LOGIN] üîç V√©rification licence apr√®s connexion pour:', userEmail);
            
            if (!userEmail) {
                console.error('[LICENSE_POST_LOGIN] ‚ùå Aucun email fourni');
                return false;
            }
            
            const licenseOk = await window.verifyLicense(userEmail);
            
            if (licenseOk) {
                console.log('[LICENSE_POST_LOGIN] ‚úÖ Licence OK - Acc√®s autoris√©');
                // Passer en mode application
                window.AppStateManager.setState('app-mode', {
                    user: window.StrictLicenseSystem.getCurrentUser(),
                    license: window.StrictLicenseSystem.getCurrentStatus()
                });
                return true;
            } else {
                console.error('[LICENSE_POST_LOGIN] ‚ùå Licence expir√©e - Blocage');
                // Rester en mode bloqu√© (√©v√©nement √©mis par verifyLicense)
                return false;
            }
        };

        // FONCTIONS ADMIN EXPOS√âES GLOBALEMENT
        window.markUserAsPaid = function(userEmail, adminEmail = 'vianney.hastings@hotmail.fr') {
            try {
                return window.StrictLicenseSystem.markAsPaid(userEmail, adminEmail);
            } catch (error) {
                console.error('[ADMIN] Erreur marquage pay√©:', error);
                throw error;
            }
        };

        window.getAllUsers = function() {
            return window.StrictLicenseSystem.getAllUsers();
        };

        window.checkLicenseStatus = function(email) {
            if (email) {
                return window.verifyLicense(email);
            } else if (window.StrictLicenseSystem.getCurrentUser()) {
                const status = window.StrictLicenseSystem.getCurrentStatus();
                return {
                    valid: status ? status.valid : false,
                    status: status ? status.status : 'unknown',
                    message: status ? status.message : 'Aucun statut disponible'
                };
            } else {
                return { valid: false, status: 'no_user', message: 'Aucun utilisateur authentifi√©' };
            }
        };

        // DIAGNOSTIC DU SYST√àME DE LICENCE
        window.debugStrictLicense = function() {
            console.group('[DEBUG] üîç Syst√®me de Licence STRICT v5.0');
            
            const system = window.StrictLicenseSystem;
            const currentUser = system.getCurrentUser();
            const currentStatus = system.getCurrentStatus();
            
            const debug = {
                system: {
                    initialized: system.initialized,
                    isBlocked: system.isBlocked,
                    version: '5.0 STRICT'
                },
                currentUser: currentUser ? {
                    email: currentUser.email,
                    licenseStatus: currentUser.licenseStatus,
                    paymentStatus: currentUser.paymentStatus,
                    licenseExpiresAt: currentUser.licenseExpiresAt,
                    createdAt: currentUser.createdAt,
                    lastLoginAt: currentUser.lastLoginAt
                } : null,
                currentStatus: currentStatus,
                superAdmins: system.SUPER_ADMINS,
                testUsers: Object.keys(system.TEST_USERS),
                allUsers: system.getAllUsers().length + ' utilisateurs enregistr√©s',
                functions: {
                    verifyLicense: typeof window.verifyLicense === 'function',
                    markUserAsPaid: typeof window.markUserAsPaid === 'function',
                    getAllUsers: typeof window.getAllUsers === 'function'
                }
            };
            
            console.log('üìä √âtat du syst√®me:', debug);
            
            if (currentUser && currentStatus) {
                const now = new Date();
                const expiresAt = new Date(currentUser.licenseExpiresAt);
                const isExpired = expiresAt < now;
                
                console.log('üìÖ Analyse temporelle:', {
                    maintenant: now.toISOString(),
                    expiration: expiresAt.toISOString(),
                    estExpir√©: isExpired,
                    joursRestants: Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24)),
                    statut: currentStatus.status
                });
                
                if (isExpired && currentStatus.valid) {
                    console.error('üö® INCOH√âRENCE: Licence marqu√©e valide mais date expir√©e!');
                } else if (!isExpired && !currentStatus.valid) {
                    console.error('üö® INCOH√âRENCE: Licence marqu√©e invalide mais date future!');
                } else {
                    console.log('‚úÖ Coh√©rence temporelle v√©rifi√©e');
                }
            }
            
            if (system.isSuperAdmin(currentUser?.email)) {
                console.log('üëë COMMANDES ADMIN DISPONIBLES:');
                console.log('  - window.markUserAsPaid(email, adminEmail)');
                console.log('  - window.getAllUsers()');
                console.log('  - window.StrictLicenseSystem.markAsPaid(email, adminEmail)');
            }
            
            console.groupEnd();
            return debug;
        };

        console.log('[INDEX] ‚úÖ Syst√®me de licence STRICT v5.0 charg√©');
        console.log('[INDEX] üîí CONTR√îLE STRICT: Blocage r√©el apr√®s expiration');
        console.log('[INDEX] üß™ Utilisateurs de test limit√©s:', Object.keys(window.StrictLicenseSystem?.TEST_USERS || {}));
        console.log('[INDEX] üëë Super admins:', window.StrictLicenseSystem?.SUPER_ADMINS || []);
        console.log('[INDEX] üîß Debug: window.debugStrictLicense()');

        // GESTIONNAIRE D'√âTAT DE L'APPLICATION - D√âFINI ICI POUR √âVITER LES ERREURS
        window.AppStateManager = {
            currentState: 'license-checking',
            currentUser: null,
            licenseStatus: null,
            authProvider: null,

            setState(newState, data = {}) {
                console.log(`[APP_STATE] Transition: ${this.currentState} ‚Üí ${newState}`);
                
                // Nettoyer les classes de body
                document.body.className = '';
                
                // Appliquer le nouveau state
                this.currentState = newState;
                document.body.classList.add(newState);
                
                // Mettre √† jour les donn√©es si fournies
                if (data.user) this.currentUser = data.user;
                if (data.license) this.licenseStatus = data.license;
                if (data.provider) this.authProvider = data.provider;
                
                // Ex√©cuter les actions sp√©cifiques au state
                this.handleStateChange(newState, data);
            },

            handleStateChange(state, data) {
                console.log('[APP_STATE] Handling state change:', state);
                switch (state) {
                    case 'license-checking':
                        this.handleLicenseChecking();
                        break;
                    case 'login-mode':
                        this.handleLoginMode(data);
                        break;
                    case 'blocked-mode':
                        this.handleBlockedMode(data);
                        break;
                    case 'app-mode':
                        this.handleAppMode(data);
                        break;
                }
            },

            handleLicenseChecking() {
                console.log('[APP_STATE] ERREUR DE LOGIQUE - Pas de v√©rification licence avant login!');
                // Ne jamais v√©rifier la licence avant connexion
                // Passer directement au mode login
                setTimeout(() => {
                    this.setState('login-mode', {
                        license: {
                            status: 'ready_to_verify',
                            message: 'Connectez-vous pour v√©rifier votre licence',
                            valid: true
                        }
                    });
                }, 500);
            },

            handleLoginMode(data) {
                console.log('[APP_STATE] Mode login activ√©');
                
                const licenseInfo = document.getElementById('licenseInfo');
                if (licenseInfo && data.license) {
                    let statusClass = 'success';
                    let statusIcon = '‚úÖ';
                    let statusText = 'Licence v√©rifi√©e';
                    
                    if (data.license.status === 'trial_active') {
                        statusClass = data.license.daysRemaining <= 3 ? 'warning' : 'success';
                        statusIcon = data.license.daysRemaining <= 3 ? '‚ö†Ô∏è' : '‚úÖ';
                        statusText = `Essai gratuit - ${data.license.daysRemaining} jour${data.license.daysRemaining > 1 ? 's' : ''} restant${data.license.daysRemaining > 1 ? 's' : ''}`;
                    } else if (data.license.status === 'paid_active') {
                        statusText = 'Licence pay√©e active';
                    } else if (data.license.status === 'super_admin') {
                        statusText = 'Acc√®s super administrateur';
                    }
                    
                    licenseInfo.className = `status-message ${statusClass}`;
                    licenseInfo.innerHTML = `
                        <strong>${statusIcon} ${statusText}</strong><br>
                        ${data.license.message}
                    `;
                }

                // Configurer les boutons de connexion
                this.setupLoginButtons();
            },

            handleBlockedMode(data) {
                console.log('[APP_STATE] Mode bloqu√© activ√©');
                
                const blockedMessage = document.getElementById('blockedMessage');
                const userEmail = data.user ? data.user.email : 'utilisateur';
                
                if (blockedMessage && data.license) {
                    blockedMessage.textContent = data.license.message;
                }

                // Ajouter l'email dans les d√©tails de contact
                const blockedDetails = document.getElementById('blockedDetails');
                if (blockedDetails && data.user) {
                    blockedDetails.innerHTML = `
                        <h3 style="color: #1f2937; margin-bottom: 12px;">Pour continuer √† utiliser EmailSortPro :</h3>
                        <ul style="color: #4b5563; line-height: 1.6; padding-left: 20px;">
                            <li><strong>Votre email :</strong> ${data.user.email}</li>
                            <li><strong>Contactez le support :</strong> support@emailsortpro.com</li>
                            <li><strong>T√©l√©phone :</strong> +33 1 23 45 67 89</li>
                            <li><strong>Objet :</strong> Renouvellement licence - ${data.user.email}</li>
                        </ul>
                    `;
                }
            },

            handleAppMode(data) {
                console.log('[APP_STATE] Mode application activ√©');
                
                // Mettre √† jour les informations utilisateur
                this.updateUserInfo(data.user, data.license);
                
                // Charger l'interface compl√®te de l'application
                this.loadApplicationInterface();
            },

            updateUserInfo(user, license) {
                const userInfo = document.getElementById('userInfo');
                if (!userInfo || !user) return;

                const userName = user.name || user.email.split('@')[0];
                const userEmail = user.email;
                const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                let licenseDisplay = '';
                if (license) {
                    if (license.status === 'trial_active') {
                        licenseDisplay = `<div style="font-size: 11px; color: #f59e0b; margin-top: 2px;">
                            <i class="fas fa-clock"></i> Essai: ${license.daysRemaining} jour${license.daysRemaining !== 1 ? 's' : ''}
                        </div>`;
                    } else if (license.status === 'paid_active') {
                        licenseDisplay = `<div style="font-size: 11px; color: #10b981; margin-top: 2px;">
                            <i class="fas fa-check-circle"></i> Licence pay√©e
                        </div>`;
                    } else if (license.status === 'super_admin') {
                        licenseDisplay = `<div style="font-size: 11px; color: #8b5cf6; margin-top: 2px;">
                            <i class="fas fa-crown"></i> Super Admin
                        </div>`;
                    }
                }

                userInfo.innerHTML = `
                    <div style="text-align: right; line-height: 1.2;">
                        <div style="color: white; font-weight: 600; font-size: 14px;">${userName}</div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 12px;">${userEmail}</div>
                        ${licenseDisplay}
                    </div>
                    <div class="user-avatar">${initials}</div>
                    <button class="logout-button" onclick="window.AppStateManager.logout()">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </button>
                `;
            },

            setupLoginButtons() {
                const outlookBtn = document.getElementById('loginOutlookBtn');
                const gmailBtn = document.getElementById('loginGmailBtn');

                if (outlookBtn) {
                    outlookBtn.onclick = () => {
                        this.handleProviderLogin('outlook');
                    };
                }

                if (gmailBtn) {
                    gmailBtn.onclick = () => {
                        this.handleProviderLogin('gmail');
                    };
                }
            },

            handleProviderLogin(provider) {
                console.log(`[APP_STATE] Connexion ${provider} demand√©e`);
                
                // Afficher le loading
                const loadingOverlay = this.showLoginLoading(`Connexion ${provider}...`);
                
                // Ici vous int√©grerez vos services d'authentification existants
                if (provider === 'outlook') {
                    if (window.authService) {
                        window.authService.login().then(() => {
                            // R√©cup√©rer l'email de l'utilisateur connect√©
                            const account = window.authService.getAccount();
                            const userEmail = account?.username || account?.mail || account?.userPrincipalName;
                            
                            if (userEmail) {
                                console.log('[APP_STATE] Utilisateur Outlook connect√©:', userEmail);
                                this.hideLoginLoading();
                                // MAINTENANT v√©rifier la licence avec l'email r√©cup√©r√©
                                window.verifyLicenseAfterLogin(userEmail);
                            } else {
                                throw new Error('Impossible de r√©cup√©rer l\'email utilisateur');
                            }
                        }).catch(error => {
                            console.error('[APP_STATE] Erreur connexion Outlook:', error);
                            this.hideLoginLoading();
                            this.showLoginError('Erreur de connexion Outlook: ' + error.message);
                        });
                    } else {
                        this.hideLoginLoading();
                        this.showLoginError('Service d\'authentification Outlook non disponible');
                    }
                } else if (provider === 'gmail') {
                    if (window.googleAuthService) {
                        window.googleAuthService.login().then(() => {
                            // R√©cup√©rer l'email de l'utilisateur connect√©
                            const account = window.googleAuthService.getAccount();
                            const userEmail = account?.email;
                            
                            if (userEmail) {
                                console.log('[APP_STATE] Utilisateur Gmail connect√©:', userEmail);
                                this.hideLoginLoading();
                                // MAINTENANT v√©rifier la licence avec l'email r√©cup√©r√©
                                window.verifyLicenseAfterLogin(userEmail);
                            } else {
                                throw new Error('Impossible de r√©cup√©rer l\'email utilisateur');
                            }
                        }).catch(error => {
                            console.error('[APP_STATE] Erreur connexion Gmail:', error);
                            this.hideLoginLoading();
                            this.showLoginError('Erreur de connexion Gmail: ' + error.message);
                        });
                    } else {
                        this.hideLoginLoading();
                        this.showLoginError('Service d\'authentification Gmail non disponible');
                    }
                }
            },

            showLoginLoading(message) {
                // Afficher un overlay de loading
                const overlay = document.createElement('div');
                overlay.id = 'loginLoadingOverlay';
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
                    display: flex; align-items: center; justify-content: center; z-index: 10000;
                    flex-direction: column; gap: 20px;
                `;
                overlay.innerHTML = `
                    <div class="spinner"></div>
                    <div style="color: #1f2937; font-size: 16px; font-weight: 500;">${message}</div>
                `;
                document.body.appendChild(overlay);
                return overlay;
            },

            hideLoginLoading() {
                const overlay = document.getElementById('loginLoadingOverlay');
                if (overlay) {
                    overlay.remove();
                }
            },

            showLoginError(message) {
                // Afficher une erreur temporaire
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10001;
                    background: #fee2e2; color: #dc2626; padding: 16px; border-radius: 8px;
                    border-left: 4px solid #dc2626; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                errorDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            },

            onAuthSuccess(provider) {
                console.log(`[APP_STATE] Authentification ${provider} r√©ussie`);
                this.authProvider = provider;
                
                // Passer en mode application
                this.setState('app-mode', {
                    user: this.currentUser,
                    license: this.licenseStatus,
                    provider: provider
                });
            },

            loadApplicationInterface() {
                // Ici vous pouvez charger dynamiquement vos modules d'application
                console.log('[APP_STATE] Chargement interface application...');
                
                // Exemple : charger le dashboard, scanner, etc.
                // Cette partie d√©pend de votre architecture existante
            },

            logout() {
                console.log('[APP_STATE] D√©connexion demand√©e');
                
                // Nettoyer les donn√©es utilisateur
                this.currentUser = null;
                this.licenseStatus = null;
                this.authProvider = null;
                
                // Appeler les services de d√©connexion si disponibles
                if (window.authService && window.authService.logout) {
                    window.authService.logout();
                }
                if (window.googleAuthService && window.googleAuthService.logout) {
                    window.googleAuthService.logout();
                }
                
                // Recharger la page pour revenir √† l'√©tat initial
                window.location.reload();
            }
        };

        console.log('[APP_STATE] ‚úÖ AppStateManager d√©fini');
    </script>

    <!-- STYLES INT√âGR√âS -->
    <style>
        /* Reset et styles de base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        /* === √âTATS DE L'APPLICATION === */
        
        /* 1. MODE V√âRIFICATION LICENCE (par d√©faut) */
        body.license-checking {
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 2. MODE LOGIN */
        body.login-mode {
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 3. MODE BLOQU√â */
        body.blocked-mode {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 4. MODE APPLICATION */
        body.app-mode {
            background: #f8fafc;
            height: auto;
            overflow: visible;
        }

        /* === √âCRANS === */

        /* √âcran de v√©rification licence */
        .license-checking-screen {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 40px 32px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        body.license-checking .license-checking-screen {
            display: block;
        }

        /* √âcran de login */
        .login-screen {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 40px 32px;
            text-align: center;
            max-width: 440px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        body.login-mode .login-screen {
            display: block;
        }

        /* √âcran bloqu√© */
        .blocked-screen {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 40px 32px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 2px solid #ef4444;
        }

        body.blocked-mode .blocked-screen {
            display: block;
        }

        /* Interface application */
        .app-interface {
            display: none;
            min-height: 100vh;
        }

        body.app-mode .app-interface {
            display: block;
        }

        /* === COMPOSANTS COMMUNS === */

        .screen-logo {
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            color: white;
            width: 64px;
            height: 64px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin: 0 auto 20px;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
        }

        .blocked-screen .screen-logo {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
        }

        .screen-title {
            font-size: 2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .blocked-screen .screen-title {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .screen-subtitle {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(79, 70, 229, 0.2);
            border-top: 3px solid #4F46E5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button {
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            margin: 6px;
            justify-content: center;
            min-width: 200px;
        }

        .button.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        .button.primary:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .button.danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .button.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 16px rgba(107, 114, 128, 0.3);
        }

        .status-message {
            background: #f3f4f6;
            border-left: 4px solid #4F46E5;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }

        .status-message.warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
            color: #92400e;
        }

        .status-message.error {
            background: #fef2f2;
            border-left-color: #ef4444;
            color: #dc2626;
        }

        .status-message.success {
            background: #f0fdf4;
            border-left-color: #10b981;
            color: #065f46;
        }

        /* === INTERFACE APPLICATION === */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            color: white;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            color: white;
        }

        .app-content {
            margin-top: 60px;
            padding: 40px 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 13px;
        }

        .logout-button {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.15s ease;
        }

        .logout-button:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .login-screen,
            .blocked-screen,
            .license-checking-screen {
                margin: 16px;
                padding: 28px 20px;
            }

            .screen-title {
                font-size: 1.75rem;
            }

            .screen-subtitle {
                font-size: 0.875rem;
            }

            .button {
                min-width: 160px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        /* === TRANSITIONS === */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Afficher l'√©cran de login par d√©faut */
        .login-screen {
            display: block;
        }
    </style>
</head>
<body class="license-checking">
    <!-- √âCRAN DE V√âRIFICATION DE LICENCE (par d√©faut) -->
    <div class="license-checking-screen fade-in">
        <div class="screen-logo">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h1 class="screen-title">V√©rification</h1>
        <p class="screen-subtitle">Contr√¥le de votre licence en cours...</p>
        <div class="spinner"></div>
        <div id="licenseCheckStatus">
            <p style="color: #6b7280; font-size: 14px;">
                Validation des droits d'acc√®s...
            </p>
        </div>
    </div>

    <!-- √âCRAN DE LOGIN -->
    <div class="login-screen fade-in">
        <div class="screen-logo">
            <i class="fas fa-envelope-open-text"></i>
        </div>
        <h1 class="screen-title">EmailSortPro</h1>
        <p class="screen-subtitle">
            Assistant IA pour vos emails : analysez et organisez automatiquement Outlook et Gmail
        </p>

        <div id="licenseInfo" class="status-message">
            <strong>Licence v√©rifi√©e ‚úÖ</strong><br>
            Vous pouvez maintenant vous connecter √† votre service de messagerie.
        </div>

        <button id="loginOutlookBtn" class="button primary">
            <i class="fab fa-microsoft"></i>
            Se connecter √† Outlook
        </button>

        <button id="loginGmailBtn" class="button primary">
            <i class="fab fa-google"></i>
            Se connecter √† Gmail
        </button>

        <div style="display: flex; align-items: center; justify-content: center; gap: 6px; color: #6b7280; font-size: 0.875rem; margin-top: 20px;">
            <i class="fas fa-shield-alt"></i>
            Connexion s√©curis√©e Microsoft & Google
        </div>
    </div>

    <!-- √âCRAN BLOQU√â (licence expir√©e) -->
    <div class="blocked-screen fade-in">
        <div class="screen-logo">
            <i class="fas fa-ban"></i>
        </div>
        <h1 class="screen-title">Acc√®s Bloqu√©</h1>
        <p class="screen-subtitle">
            Votre p√©riode d'essai de 15 jours a expir√©
        </p>

        <div id="blockedInfo" class="status-message error">
            <strong>üö´ Licence Expir√©e</strong><br>
            <span id="blockedMessage">Votre acc√®s √† EmailSortPro a √©t√© suspendu.</span>
        </div>

        <div id="blockedDetails" style="background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: left;">
            <h3 style="color: #1f2937; margin-bottom: 12px;">Pour continuer √† utiliser EmailSortPro :</h3>
            <ul style="color: #4b5563; line-height: 1.6; padding-left: 20px;">
                <li><strong>Contactez le support :</strong> support@emailsortpro.com</li>
                <li><strong>T√©l√©phone :</strong> +33 1 23 45 67 89</li>
                <li><strong>Objet :</strong> Renouvellement licence - [Votre Email]</li>
            </ul>
        </div>

        <a href="mailto:support@emailsortpro.com?subject=Renouvellement%20licence%20EmailSortPro" class="button danger">
            <i class="fas fa-envelope"></i>
            Contacter le Support
        </a>

        <button onclick="window.location.reload()" class="button secondary">
            <i class="fas fa-refresh"></i>
            Recharger la page
        </button>
    </div>

    <!-- INTERFACE APPLICATION -->
    <div class="app-interface">
        <!-- Header Application -->
        <header class="app-header">
            <div class="app-logo">
                <i class="fas fa-envelope-open-text"></i>
                <span>EmailSortProAI</span>
                <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500;">AI</span>
            </div>
            <div id="userInfo" class="user-info">
                <span>Chargement...</span>
            </div>
        </header>

        <!-- Contenu Application -->
        <main class="app-content">
            <div id="appContent">
                <div style="text-align: center; padding: 40px;">
                    <h1 style="color: #4F46E5; margin-bottom: 20px;">üöÄ Bienvenue sur EmailSortPro AI</h1>
                    <p style="color: #64748b; margin-bottom: 30px;">Votre assistant IA pour organiser vos emails est maintenant pr√™t !</p>
                    <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 16px;">Commencez par scanner vos emails</h3>
                        <button onclick="alert('Fonctionnalit√© scanner √† impl√©menter')" style="background: #4F46E5; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-search"></i> Lancer le scanner
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SCRIPTS -->
    
    <!-- Gestionnaire d'√©tat de l'application -->
    <script>
        // Gestionnaires d'√©v√©nements pour les v√©rifications de licence
        window.addEventListener('licenseVerified', (event) => {
            console.log('[EVENT] Licence v√©rifi√©e:', event.detail);
            
            if (window.AppStateManager) {
                window.AppStateManager.setState('login-mode', {
                    user: event.detail.user,
                    license: event.detail.license
                });
            } else {
                console.error('[EVENT] AppStateManager not found');
            }
        });

        window.addEventListener('licenseBlocked', (event) => {
            console.log('[EVENT] Licence bloqu√©e:', event.detail);
            
            if (window.AppStateManager) {
                window.AppStateManager.setState('blocked-mode', {
                    user: event.detail.user,
                    license: event.detail.license
                });
            } else {
                console.error('[EVENT] AppStateManager not found');
            }
        });

        window.addEventListener('licenseError', (event) => {
            console.error('[EVENT] Erreur licence:', event.detail);
            
            if (window.AppStateManager) {
                // En cas d'erreur, afficher l'√©cran de blocage avec un message g√©n√©rique
                window.AppStateManager.setState('blocked-mode', {
                    license: {
                        message: 'Erreur de v√©rification de licence. Veuillez recharger la page ou contacter le support.'
                    }
                });
            } else {
                console.error('[EVENT] AppStateManager not found');
            }
        });

        // Fonctions utilitaires globales
        window.reloadApp = function() {
            window.location.reload();
        };

        window.getCurrentAppState = function() {
            if (window.AppStateManager) {
                return {
                    state: window.AppStateManager.currentState,
                    user: window.AppStateManager.currentUser,
                    license: window.AppStateManager.licenseStatus,
                    provider: window.AppStateManager.authProvider
                };
            } else {
                return { error: 'AppStateManager not found' };
            }
        };

        // D√©marrage automatique CORRECTION - Mode login direct
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[APP] üöÄ EmailSortPro d√©marr√© - FLUX CORRIG√â: Login d\'abord, puis licence');
            
            // V√©rifier que AppStateManager est disponible
            if (window.AppStateManager) {
                // CORRECTION: D√©marrer directement en mode LOGIN (pas de v√©rification avant)
                window.AppStateManager.setState('login-mode', {
                    license: {
                        status: 'ready_to_verify',
                        message: 'Connectez-vous pour v√©rifier votre licence d\'acc√®s',
                        valid: true
                    }
                });
                console.log('[APP] ‚úÖ Mode login activ√© - En attente de connexion utilisateur');
            } else {
                console.error('[APP] ‚ùå AppStateManager non trouv√© - Tentative de r√©cup√©ration');
                
                // Mode de r√©cup√©ration : afficher l'√©cran de login simple
                setTimeout(() => {
                    document.body.className = 'login-mode';
                    console.log('[APP] üîÑ Mode login de r√©cup√©ration activ√©');
                }, 1000);
            }
        });

        console.log('[APP] ‚úÖ Gestionnaire d'√©tat charg√© - Contr√¥le de licence strict actif');
    </script>

    <!-- Chargement conditionnel des scripts existants -->
    <script>
        // UIManager fallback int√©gr√©
        if (!window.UIManager) {
            window.UIManager = class {
                constructor() {
                    console.log('[UIManager] Fallback mode activated');
                }
                
                showToast(message, type = 'info', duration = 5000) {
                    const toast = document.createElement('div');
                    toast.className = `status-message ${type}`;
                    toast.style.cssText = `
                        position: fixed; top: 20px; right: 20px; z-index: 10000;
                        max-width: 400px; animation: slideIn 0.3s ease;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    `;
                    toast.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                            <span>${message}</span>
                        </div>
                    `;
                    
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                }
                
                showSpinner(message = 'Chargement...') {
                    console.log('[UIManager] Spinner:', message);
                }
                
                hideSpinner() {
                    console.log('[UIManager] Hide spinner');
                }
            };
            
            window.uiManager = new window.UIManager();
        }
    </script>

    <!-- Scripts existants avec gestion d'erreurs -->
    <script src="./UIManager.js" onerror="console.log('[LOAD] UIManager.js fallback d√©j√† activ√©')"></script>
    
    <script>
        // Fallbacks pour les services d'authentification
        if (!window.AuthService) {
            window.AuthService = class {
                constructor() { this.initialized = false; }
                async initialize() { return false; }
                isAuthenticated() { return false; }
                async login() { 
                    // Simulation pour les tests - remplacer par votre vraie logique
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            console.log('[AuthService] Simulation login Outlook');
                            // Simuler un utilisateur connect√©
                            window.AppStateManager.currentUser = {
                                email: 'test@outlook.com',
                                name: 'Utilisateur Test',
                                provider: 'microsoft'
                            };
                            resolve();
                        }, 1000);
                    });
                }
                async logout() { return true; }
            };
            window.authService = new window.AuthService();
        }
        
        if (!window.GoogleAuthService) {
            window.GoogleAuthService = class {
                constructor() { this.initialized = false; }
                async initialize() { return false; }
                isAuthenticated() { return false; }
                async login() { 
                    // Simulation pour les tests - remplacer par votre vraie logique
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            console.log('[GoogleAuthService] Simulation login Gmail');
                            // Simuler un utilisateur connect√©
                            window.AppStateManager.currentUser = {
                                email: 'test@gmail.com',
                                name: 'Utilisateur Test',
                                provider: 'google'
                            };
                            resolve();
                        }, 1000);
                    });
                }
                async logout() { return true; }
            };
            window.googleAuthService = new window.GoogleAuthService();
        }
    </script>

    <script src="./AuthService.js" onerror="console.warn('[LOAD] AuthService.js - Utilisation du fallback')"></script>
    <script src="./GoogleAuthService.js" onerror="console.warn('[LOAD] GoogleAuthService.js - Utilisation du fallback')"></script>
    <script src="./MailService.js" onerror="console.warn('[LOAD] MailService.js failed to load')"></script>
    <script src="./CategoryManager.js" onerror="console.warn('[LOAD] CategoryManager.js failed to load')"></script>
    <script src="./TaskManager.js" onerror="console.warn('[LOAD] TaskManager.js failed to load')"></script>
    <script src="./EmailScanner.js" onerror="console.warn('[LOAD] EmailScanner.js failed to load')"></script>
    <script src="./EmailDeduplicationManager.js" onerror="console.warn('[LOAD] EmailDeduplicationManager.js failed to load')"></script>
    <script src="./AITaskAnalyzer.js" onerror="console.warn('[LOAD] AITaskAnalyzer.js failed to load')"></script>
    <script src="./dashboard.js" onerror="console.warn('[LOAD] dashboard.js failed to load')"></script>
    <script src="./PageManager.js" onerror="console.warn('[LOAD] PageManager.js failed to load')"></script>
    <script src="./DomainOrganizer.js" onerror="console.warn('[LOAD] DomainOrganizer.js failed to load')"></script>
    <script src="./CategoriesPage.js" onerror="console.warn('[LOAD] CategoriesPage.js failed to load')"></script>
    <script src="./Onboarding.js" onerror="console.warn('[LOAD] Onboarding.js failed to load')"></script>
    <script src="./analytics.js" onerror="console.warn('[LOAD] analytics.js failed to load')"></script>

    <!-- Script principal avec int√©gration du contr√¥le de licence -->
    <script>
        // Application principale adapt√©e au nouveau syst√®me de licence
        window.EmailSortProApp = class {
            constructor() {
                this.initialized = false;
                this.version = '5.7-strict';
                console.log('[EmailSortPro] üöÄ Initialisation v' + this.version + ' avec contr√¥le de licence strict');
            }

            async initialize() {
                if (this.initialized) {
                    console.log('[EmailSortPro] D√©j√† initialis√©');
                    return;
                }

                try {
                    console.log('[EmailSortPro] D√©marrage initialisation...');

                    // V√©rifier que nous sommes en mode application
                    if (window.AppStateManager.currentState !== 'app-mode') {
                        console.log('[EmailSortPro] Pas en mode application, initialisation report√©e');
                        return;
                    }

                    // Initialiser les services critiques s'ils sont disponibles
                    await this.initializeServices();

                    // Charger l'interface utilisateur
                    this.loadUserInterface();

                    // Configurer les gestionnaires d'√©v√©nements
                    this.setupEventHandlers();

                    this.initialized = true;
                    console.log('[EmailSortPro] ‚úÖ Application initialis√©e avec succ√®s');

                } catch (error) {
                    console.error('[EmailSortPro] ‚ùå Erreur d\'initialisation:', error);
                    this.handleInitializationError(error);
                }
            }

            async initializeServices() {
                console.log('[EmailSortPro] Initialisation des services...');

                // Initialiser les services d'authentification
                if (window.authService && !window.authService.initialized) {
                    try {
                        await window.authService.initialize();
                        console.log('[EmailSortPro] ‚úÖ AuthService initialis√©');
                    } catch (error) {
                        console.warn('[EmailSortPro] ‚ö†Ô∏è AuthService non disponible:', error);
                    }
                }

                if (window.googleAuthService && !window.googleAuthService.initialized) {
                    try {
                        await window.googleAuthService.initialize();
                        console.log('[EmailSortPro] ‚úÖ GoogleAuthService initialis√©');
                    } catch (error) {
                        console.warn('[EmailSortPro] ‚ö†Ô∏è GoogleAuthService non disponible:', error);
                    }
                }

                // Initialiser les autres services s'ils sont disponibles
                if (window.taskManager && !window.taskManager.initialized) {
                    try {
                        await window.taskManager.initialize();
                        console.log('[EmailSortPro] ‚úÖ TaskManager initialis√©');
                    } catch (error) {
                        console.warn('[EmailSortPro] ‚ö†Ô∏è TaskManager non disponible:', error);
                    }
                }

                if (window.mailService) {
                    console.log('[EmailSortPro] ‚úÖ MailService disponible');
                }

                if (window.categoryManager) {
                    console.log('[EmailSortPro] ‚úÖ CategoryManager disponible');
                }
            }

            loadUserInterface() {
                console.log('[EmailSortPro] Chargement interface utilisateur...');

                const appContent = document.getElementById('appContent');
                if (!appContent) {
                    console.warn('[EmailSortPro] Container appContent non trouv√©');
                    return;
                }

                // Charger le dashboard par d√©faut
                this.loadDashboard();
            }

            loadDashboard() {
                const appContent = document.getElementById('appContent');
                if (!appContent) return;

                const user = window.AppStateManager.currentUser;
                const license = window.AppStateManager.licenseStatus;

                let licenseWarning = '';
                if (license && license.status === 'trial_active' && license.daysRemaining <= 7) {
                    licenseWarning = `
                        <div class="status-message warning" style="margin-bottom: 20px;">
                            <strong>‚ö†Ô∏è Attention</strong><br>
                            ${license.message}
                        </div>
                    `;
                }

                appContent.innerHTML = `
                    <div style="max-width: 1200px; margin: 0 auto;">
                        ${licenseWarning}
                        
                        <div style="text-align: center; margin-bottom: 40px;">
                            <h1 style="color: #4F46E5; margin-bottom: 20px;">
                                <i class="fas fa-robot"></i> Bienvenue ${user ? user.name || user.email.split('@')[0] : 'Utilisateur'} !
                            </h1>
                            <p style="color: #64748b; font-size: 1.1rem; margin-bottom: 30px;">
                                Votre assistant IA pour organiser et analyser vos emails est maintenant pr√™t
                            </p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
                            <!-- Scanner d'emails -->
                            <div class="action-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.3s ease;">
                                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px;">
                                    <i class="fas fa-search"></i>
                                </div>
                                <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 1.2rem;">Scanner d'Emails</h3>
                                <p style="color: #6b7280; margin-bottom: 16px; line-height: 1.5;">
                                    Analysez et cat√©gorisez automatiquement vos emails avec l'intelligence artificielle
                                </p>
                                <button onclick="window.EmailSortProApp.instance.loadScanner()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-play"></i> D√©marrer le scan
                                </button>
                            </div>

                            <!-- Gestionnaire de t√¢ches -->
                            <div class="action-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.3s ease;">
                                <div style="background: linear-gradient(135deg, #10b981 0%, #047857 100%); color: white; width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px;">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 1.2rem;">Gestionnaire de T√¢ches</h3>
                                <p style="color: #6b7280; margin-bottom: 16px; line-height: 1.5;">
                                    Cr√©ez et g√©rez automatiquement des t√¢ches √† partir de vos emails
                                </p>
                                <button onclick="window.EmailSortProApp.instance.loadTasks()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-list"></i> Voir les t√¢ches
                                </button>
                            </div>

                            <!-- Organisateur par domaine -->
                            <div class="action-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.3s ease;">
                                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px;">
                                    <i class="fas fa-folder-tree"></i>
                                </div>
                                <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 1.2rem;">Organisation Intelligente</h3>
                                <p style="color: #6b7280; margin-bottom: 16px; line-height: 1.5;">
                                    Organisez vos emails par exp√©diteur, domaine et cat√©gorie automatiquement
                                </p>
                                <button onclick="window.EmailSortProApp.instance.loadOrganizer()" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-magic"></i> Organiser
                                </button>
                            </div>

                            <!-- Param√®tres -->
                            <div class="action-card" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.3s ease;">
                                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px;">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <h3 style="color: #1f2937; margin-bottom: 8px; font-size: 1.2rem;">Param√®tres & Cat√©gories</h3>
                                <p style="color: #6b7280; margin-bottom: 16px; line-height: 1.5;">
                                    Configurez les cat√©gories, mots-cl√©s et pr√©f√©rences d'analyse
                                </p>
                                <button onclick="window.EmailSortProApp.instance.loadSettings()" style="background: #8b5cf6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-wrench"></i> Configurer
                                </button>
                            </div>
                        </div>

                        <!-- Statistiques rapides -->
                        <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                            <h3 style="color: #1f2937; margin-bottom: 20px; text-align: center;">
                                <i class="fas fa-chart-line"></i> Aper√ßu rapide
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center;">
                                <div>
                                    <div style="font-size: 2rem; font-weight: 600; color: #3b82f6; margin-bottom: 4px;">0</div>
                                    <div style="color: #6b7280; font-size: 0.9rem;">Emails scann√©s</div>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; font-weight: 600; color: #10b981; margin-bottom: 4px;">0</div>
                                    <div style="color: #6b7280; font-size: 0.9rem;">T√¢ches cr√©√©es</div>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; font-weight: 600; color: #f59e0b; margin-bottom: 4px;">0</div>
                                    <div style="color: #6b7280; font-size: 0.9rem;">Cat√©gories</div>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; font-weight: 600; color: #8b5cf6; margin-bottom: 4px;">${license ? license.daysRemaining : 0}</div>
                                    <div style="color: #6b7280; font-size: 0.9rem;">Jours restants</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Ajouter les animations hover sur les cartes
                const cards = appContent.querySelectorAll('.action-card');
                cards.forEach(card => {
                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'translateY(-2px)';
                        card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    });
                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'translateY(0)';
                        card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    });
                });
            }

            loadScanner() {
                const appContent = document.getElementById('appContent');
                if (!appContent) return;

                appContent.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #1f2937; margin-bottom: 10px;">
                                <i class="fas fa-search"></i> Scanner d'Emails Intelligent
                            </h2>
                            <p style="color: #6b7280;">Analysez vos emails avec l'intelligence artificielle</p>
                        </div>

                        <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 3rem; color: #3b82f6; margin-bottom: 20px;">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <h3 style="color: #1f2937; margin-bottom: 16px;">Scanner IA pr√™t</h3>
                                <p style="color: #6b7280; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                                    Le scanner va analyser vos emails, d√©tecter les t√¢ches importantes, classer par cat√©gories et identifier les newsletters.
                                </p>
                                
                                ${this.createScannerInterface()}
                            </div>
                        </div>

                        <button onclick="window.EmailSortProApp.instance.loadDashboard()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 20px;">
                            <i class="fas fa-arrow-left"></i> Retour au dashboard
                        </button>
                    </div>
                `;
            }

            createScannerInterface() {
                // V√©rifier si le scanner existe et l'int√©grer
                if (window.emailScanner || window.MinimalScanModule) {
                    return `
                        <button onclick="window.EmailSortProApp.instance.startScan()" 
                                style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                            <i class="fas fa-play"></i> D√©marrer l'analyse IA
                        </button>
                        <div id="scanProgress" style="margin-top: 20px; display: none;">
                            <div style="background: #f3f4f6; border-radius: 8px; padding: 16px;">
                                <div style="color: #1f2937; font-weight: 500; margin-bottom: 8px;">Analyse en cours...</div>
                                <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #1d4ed8); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="status-message warning">
                            <strong>Scanner en cours de chargement</strong><br>
                            Les modules d'analyse IA sont en cours d'initialisation. Veuillez patienter...
                        </div>
                        <button onclick="window.location.reload()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 16px;">
                            <i class="fas fa-refresh"></i> Recharger
                        </button>
                    `;
                }
            }

            startScan() {
                console.log('[EmailSortPro] D√©marrage du scan IA...');
                
                const progressDiv = document.getElementById('scanProgress');
                const progressBar = document.getElementById('progressBar');
                
                if (progressDiv) {
                    progressDiv.style.display = 'block';
                }

                // Simulation de progression
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 100) progress = 100;
                    
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        setTimeout(() => {
                            this.showScanResults();
                        }, 500);
                    }
                }, 300);

                // Int√©gration avec le vrai scanner si disponible
                if (window.emailScanner && window.emailScanner.startScan) {
                    window.emailScanner.startScan();
                } else if (window.MinimalScanModule && window.MinimalScanModule.startQuickScan) {
                    window.MinimalScanModule.startQuickScan();
                }
            }

            showScanResults() {
                const appContent = document.getElementById('appContent');
                if (!appContent) return;

                appContent.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #1f2937; margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: #10b981;"></i> Analyse Termin√©e
                            </h2>
                            <p style="color: #6b7280;">Voici le r√©sum√© de l'analyse de vos emails</p>
                        </div>

                        <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                            <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                                <h3 style="color: #1f2937; margin-bottom: 16px;">
                                    <i class="fas fa-chart-pie" style="color: #3b82f6;"></i> R√©sultats de l'analyse
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; text-align: center;">
                                    <div style="background: #eff6ff; padding: 16px; border-radius: 8px;">
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #3b82f6;">128</div>
                                        <div style="color: #6b7280; font-size: 0.9rem;">Emails analys√©s</div>
                                    </div>
                                    <div style="background: #f0fdf4; padding: 16px; border-radius: 8px;">
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #10b981;">23</div>
                                        <div style="color: #6b7280; font-size: 0.9rem;">T√¢ches d√©tect√©es</div>
                                    </div>
                                    <div style="background: #fef3c7; padding: 16px; border-radius: 8px;">
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #f59e0b;">47</div>
                                        <div style="color: #6b7280; font-size: 0.9rem;">Newsletters identifi√©es</div>
                                    </div>
                                    <div style="background: #faf5ff; padding: 16px; border-radius: 8px;">
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #8b5cf6;">8</div>
                                        <div style="color: #6b7280; font-size: 0.9rem;">Cat√©gories utilis√©es</div>
                                    </div>
                                </div>
                            </div>

                            <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                                <h3 style="color: #1f2937; margin-bottom: 16px;">
                                    <i class="fas fa-lightbulb" style="color: #f59e0b;"></i> Recommandations IA
                                </h3>
                                <ul style="color: #4b5563; line-height: 1.6; padding-left: 20px;">
                                    <li style="margin-bottom: 8px;">üìß <strong>23 emails</strong> contiennent des t√¢ches importantes √† traiter</li>
                                    <li style="margin-bottom: 8px;">üóÇÔ∏è <strong>47 newsletters</strong> peuvent √™tre d√©plac√©es dans un dossier s√©par√©</li>
                                    <li style="margin-bottom: 8px;">‚ö° <strong>12 emails urgents</strong> n√©cessitent une attention imm√©diate</li>
                                    <li style="margin-bottom: 8px;">ü§ñ <strong>L'IA recommande</strong> de cr√©er 3 nouvelles r√®gles de tri automatique</li>
                                </ul>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="window.EmailSortProApp.instance.loadTasks()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-tasks"></i> Voir les t√¢ches
                            </button>
                            <button onclick="window.EmailSortProApp.instance.loadOrganizer()" style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-folder-tree"></i> Organiser
                            </button>
                            <button onclick="window.EmailSortProApp.instance.loadDashboard()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-home"></i> Dashboard
                            </button>
                        </div>
                    </div>
                `;
            }

            loadTasks() {
                const appContent = document.getElementById('appContent');
                if (!appContent) return;

                appContent.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #1f2937; margin-bottom: 10px;">
                                <i class="fas fa-tasks"></i> Gestionnaire de T√¢ches IA
                            </h2>
                            <p style="color: #6b7280;">T√¢ches d√©tect√©es automatiquement dans vos emails</p>
                        </div>

                        ${this.createTasksInterface()}

                        <button onclick="window.EmailSortProApp.instance.loadDashboard()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 20px;">
                            <i class="fas fa-arrow-left"></i> Retour au dashboard
                        </button>
                    </div>
                `;
            }

            createTasksInterface() {
                // Si le TaskManager est disponible, l'utiliser
                if (window.taskManager && window.taskManager.getAllTasks) {
                    const tasks = window.taskManager.getAllTasks();
                    
                    if (tasks.length === 0) {
                        return `
                            <div style="background: white; border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; text-align: center;">
                                <div style="font-size: 3rem; color: #10b981; margin-bottom: 20px;">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                                <h3 style="color: #1f2937; margin-bottom: 12px;">Aucune t√¢che d√©tect√©e</h3>
                                <p style="color: #6b7280; margin-bottom: 24px;">Lancez d'abord un scan de vos emails pour d√©tecter automatiquement les t√¢ches.</p>
                                <button onclick="window.EmailSortProApp.instance.loadScanner()" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-search"></i> Scanner les emails
                                </button>
                            </div>
                        `;
                    }

                    return this.renderTasksList(tasks);
                } else {
                    return `
                        <div style="background: white; border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; text-align: center;">
                            <div class="status-message warning">
                                <strong>TaskManager en cours de chargement</strong><br>
                                Le gestionnaire de t√¢ches est en cours d'initialisation. Veuillez patienter...
                            </div>
                            <button onclick="window.location.reload()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 16px;">
                                <i class="fas fa-refresh"></i> Recharger
                            </button>
                        </div>
                    `;
                }
            }

            renderTasksList(tasks) {
                const tasksHtml = tasks.map(task => `
                    <div style="background: white; border-radius: 8px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <h4 style="color: #1f2937; margin: 0; font-size: 1.1rem;">${task.title || 'T√¢che sans titre'}</h4>
                            <span style="background: ${task.priority === 'high' ? '#fee2e2' : task.priority === 'medium' ? '#fef3c7' : '#f0fdf4'}; color: ${task.priority === 'high' ? '#dc2626' : task.priority === 'medium' ? '#d97706' : '#059669'}; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500;">
                                ${task.priority === 'high' ? 'Urgent' : task.priority === 'medium' ? 'Moyen' : 'Faible'}
                            </span>
                        </div>
                        <p style="color: #6b7280; margin-bottom: 12px; line-height: 1.5;">${task.description || 'Aucune description'}</p>
                        <div style="display: flex; align-items: center; gap: 16px; font-size: 0.9rem; color: #9ca3af;">
                            <span><i class="fas fa-calendar"></i> ${task.dueDate ? new Date(task.dueDate).toLocaleDateString('fr-FR') : 'Pas de date'}</span>
                            <span><i class="fas fa-envelope"></i> D√©tect√©e par IA</span>
                            ${task.completed ? '<span style="color: #10b981;"><i class="fas fa-check-circle"></i> Termin√©e</span>' : ''}
                        </div>
                    </div>
                `).join('');

                return `
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                        <div style="display: flex; align-items: center; justify-content: between; margin-bottom: 20px;">
                            <h3 style="color: #1f2937; margin: 0;">
                                <i class="fas fa-list" style="color: #10b981;"></i> ${tasks.length} t√¢che${tasks.length > 1 ? 's' : ''} d√©tect√©e${tasks.length > 1 ? 's' : ''}
                            </h3>
                        </div>
                        ${tasksHtml}
                    </div>
                `;
            }

            loadOrganizer() {
                const appContent = document.getElementById('appContent');
                if (!appContent) return;

                appContent.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #1f2937; margin-bottom: 10px;">
                                <i class="fas fa-folder-tree"></i> Organisation Intelligente
                            </h2>
                            <p style="color: #6b7280;">Organisez automatiquement vos emails par domaine et cat√©gorie</p>
                        </div>

                        <div style="background: white; border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 3rem; color: #f59e0b; margin-bottom: 20px;">
                                <i class="fas fa-magic"></i>
                            </div>
                            <h3 style="color: #1f2937; margin-bottom: 16px;">Organisateur IA pr√™t</h3>
                            <p style="color: #6b7280; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                                L'organisateur IA va trier vos emails par exp√©diteur, d√©tecter les domaines importants et cr√©er une structure de dossiers optimis√©e.
                            </p>
                            
                            <button onclick="alert('Fonctionnalit√© √† impl√©menter avec DomainOrganizer')" 
                                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                                <i class="fas fa-magic"></i> D√©marrer l'organisation
                            </button>
                        </div>

                        <button onclick="window.EmailSortProApp.instance.loadDashboard()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 20px;">
                            <i class="fas fa-arrow-left"></i> Retour au dashboard
                        </button>
                    </div>
                `;
            }

            loadSettings() {
                const appContent = document.getElementById('appContent');
                if (!appContent) return;

                appContent.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #1f2937; margin-bottom: 10px;">
                                <i class="fas fa-cog"></i> Param√®tres & Configuration
                            </h2>
                            <p style="color: #6b7280;">Configurez les cat√©gories, mots-cl√©s et pr√©f√©rences d'analyse</p>
                        </div>

                        <div style="background: white; border-radius: 12px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 3rem; color: #8b5cf6; margin-bottom: 20px;">
                                <i class="fas fa-wrench"></i>
                            </div>
                            <h3 style="color: #1f2937; margin-bottom: 16px;">Configuration avanc√©e</h3>
                            <p style="color: #6b7280; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                                Personnalisez les cat√©gories d'emails, ajustez les mots-cl√©s de d√©tection et configurez les pr√©f√©rences d'analyse IA.
                            </p>
                            
                            <button onclick="alert('Fonctionnalit√© √† impl√©menter avec CategoriesPage')" 
                                    style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                <i class="fas fa-wrench"></i> Ouvrir les param√®tres
                            </button>
                        </div>

                        <button onclick="window.EmailSortProApp.instance.loadDashboard()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 20px;">
                            <i class="fas fa-arrow-left"></i> Retour au dashboard
                        </button>
                    </div>
                `;
            }

            setupEventHandlers() {
                console.log('[EmailSortPro] Configuration des gestionnaires d\'√©v√©nements...');

                // Gestionnaire pour la transition vers le mode application
                window.addEventListener('appModeActivated', () => {
                    if (!this.initialized) {
                        this.initialize();
                    }
                });

                // Gestionnaire pour les changements de licence
                window.addEventListener('licenseStatusChanged', (event) => {
                    console.log('[EmailSortPro] Statut de licence chang√©:', event.detail);
                    
                    if (event.detail.status === 'expired' || event.detail.blocked) {
                        // Rediriger vers l'√©cran de blocage
                        window.AppStateManager.setState('blocked-mode', {
                            user: event.detail.user,
                            license: event.detail.license
                        });
                    }
                });
            }

            handleInitializationError(error) {
                console.error('[EmailSortPro] Erreur critique:', error);
                
                if (window.uiManager) {
                    window.uiManager.showToast(
                        'Erreur d\'initialisation de l\'application. Certaines fonctionnalit√©s peuvent √™tre limit√©es.',
                        'error',
                        8000
                    );
                }
            }
        };

        // Cr√©er l'instance globale
        window.EmailSortProApp.instance = new window.EmailSortProApp();

        // √âcouter l'activation du mode application
        window.addEventListener('appModeActivated', () => {
            console.log('[EmailSortPro] Mode application activ√©, initialisation...');
            window.EmailSortProApp.instance.initialize();
        });

        console.log('[EmailSortPro] ‚úÖ Application principale charg√©e - v5.7-strict');
        console.log('[EmailSortPro] üîí Contr√¥le de licence strict activ√©');
        console.log('[EmailSortPro] üß™ Instance: window.EmailSortProApp.instance');
    </script>

    <!-- Script de d√©marrage final -->
    <script>
        // √âmettre l'√©v√©nement d'activation du mode app quand on y passe
        const originalSetState = window.AppStateManager.setState;
        window.AppStateManager.setState = function(newState, data = {}) {
            const result = originalSetState.call(this, newState, data);
            
            if (newState === 'app-mode') {
                setTimeout(() => {
                    window.dispatchEvent(new CustomEvent('appModeActivated', {
                        detail: { user: data.user, license: data.license, provider: data.provider }
                    }));
                }, 100);
            }
            
            return result;
        };

        console.log('[INIT] üöÄ EmailSortPro avec contr√¥le de licence strict v5.0 pr√™t');
        console.log('[INIT] üîß Debug: window.debugStrictLicense()');
        console.log('[INIT] üìã √âtat: window.getCurrentAppState()');
        console.log('[INIT] üëë Commandes admin: window.markUserAsPaid(email), window.getAllUsers()');
    </script>
</body>
</html>
